
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Power Flow and Contingency Outline &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Power Flow and Contingency Outline';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Case Study" href="Case%20Study.html" />
    <link rel="prev" title="Welcome to a new power system screening tool for the Republic of Ireland" href="intro.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo_CLG.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="_static/logo_CLG.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to a new power system screening tool for the Republic of Ireland
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Power Flow and Contingency Outline</a></li>
<li class="toctree-l1"><a class="reference internal" href="Case%20Study.html">Case Study</a></li>
<li class="toctree-l1"><a class="reference internal" href="Hourly%20Timeseries%20Simulation.html">Hourly Timeseries Simulation</a></li>


<li class="toctree-l1"><a class="reference internal" href="Sources.html">Sources</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2FPower Flow and Contingency Outline.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/Power Flow and Contingency Outline.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Power Flow and Contingency Outline</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="power-flow-and-contingency-outline">
<h1>Power Flow and Contingency Outline<a class="headerlink" href="#power-flow-and-contingency-outline" title="Link to this heading">#</a></h1>
<p>The tool is built and regularly updated using public sources including but not limited to Eirgrid’s Ten Year Transmission Forecast Statement (TYTFS). The model operates in a simple manner for powerflow analysis, utilizing the open source tool PandaPower and other python functionality for data processing. It can easily be updated to reflect a range of scenarios and study years in order to meet the needs of the user. Note: The current model focuses exclusively on the Republic of Ireland’s (ROI) transmission network, excluding Northern Ireland (NI). Expansion is possible upon request.</p>
<p>Outputs can come in many forms, line loading and bus results can be produced by csv files in “Results” folder. Various plots are also provided for a visual representation of the load flow, worst case contingency and test energy storage net impact. Load flow is solved using ACPF newton raphson using DC initialization. Some of the practical applications are senstivity testing with and without network reinforcements, connection method comparisons, and general loadflow injection screening studies.</p>
<p><strong>Determining optimal system wind and solar capacity factors to obtain convergence</strong></p>
<ul class="simple">
<li><p>In order to build cases for screening, it’s important to first determine what the maximum tollerable wind and solar capacity factors are that will still allow each case to solve and converge properly. The goal being to find the levels of renewable energy dispatch that allow the system to converge for each unique case. Each unique case is meant to represent a slice of time from summer or winter peak demand and meeting it with the maximum amount of wind or solar generation up to the capacity factors input by the user. This is informed by assessing hourly dispatch data from ECP constraint reports, Tomorrow’s Energy Scenarios (TES), and other data from Eirgrid and ESB.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandapower</span> <span class="k">as</span> <span class="nn">pp</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pandapower.networks</span> <span class="k">as</span> <span class="nn">networks</span>
<span class="kn">import</span> <span class="nn">pandapower.contingency</span>
<span class="kn">import</span> <span class="nn">pandapower.control</span>
<span class="kn">import</span> <span class="nn">pandapower.timeseries</span>
<span class="kn">import</span> <span class="nn">pandapower.plotting</span>
<span class="kn">import</span> <span class="nn">lightsim2grid</span>
<span class="nb">print</span><span class="p">(</span><span class="n">lightsim2grid</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">from</span> <span class="nn">pandapower.pypower.makePTDF</span> <span class="kn">import</span> <span class="n">makePTDF</span>
<span class="kn">from</span> <span class="nn">pandapower.pypower.makeLODF</span> <span class="kn">import</span> <span class="n">makeLODF</span><span class="p">,</span> <span class="n">makeOTDF</span>
<span class="kn">from</span> <span class="nn">pandapower.pd2ppc</span> <span class="kn">import</span> <span class="n">_pd2ppc</span>
<span class="kn">from</span> <span class="nn">pandapower.pf.makeYbus_numba</span> <span class="kn">import</span> <span class="n">makeYbus</span>
<span class="kn">from</span> <span class="nn">pandapower.pypower.idx_brch</span> <span class="kn">import</span> <span class="n">F_BUS</span><span class="p">,</span> <span class="n">T_BUS</span><span class="p">,</span> <span class="n">BR_R</span><span class="p">,</span> <span class="n">BR_X</span><span class="p">,</span> <span class="n">BR_B</span><span class="p">,</span> <span class="n">BR_STATUS</span><span class="p">,</span> <span class="n">SHIFT</span><span class="p">,</span> <span class="n">TAP</span><span class="p">,</span> <span class="n">BR_R_ASYM</span><span class="p">,</span> <span class="n">BR_X_ASYM</span>
<span class="kn">from</span> <span class="nn">pandapower.toolbox.data_modification</span> <span class="kn">import</span> <span class="n">create_continuous_bus_index</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="c1"># Load network data from Model folder</span>
<span class="c1">#bus_names_df = pd.read_csv(&quot;Model/bus_data.csv&quot;)</span>
<span class="n">bus_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;Model/bus_data.csv&quot;</span><span class="p">)</span>
<span class="n">line_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Model/line_data.csv&#39;</span><span class="p">)</span>
<span class="n">generator_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Model/generator_data.csv&#39;</span><span class="p">)</span>
<span class="n">transformer_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Model/transformers_data.csv&#39;</span><span class="p">)</span>
<span class="n">reactive_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Model/reactive_data.csv&#39;</span><span class="p">)</span>
<span class="n">load_df_SP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Model/load_data_SP2031.csv&#39;</span><span class="p">)</span>
<span class="n">load_df_WP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Model/load_data_WP2031.csv&#39;</span><span class="p">)</span>
<span class="n">load_df_SV</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Model/load_data_SV2031.csv&#39;</span><span class="p">)</span>


<span class="c1"># Load network</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">from_pickle</span><span class="p">(</span><span class="s2">&quot;adjusted_network.p&quot;</span><span class="p">)</span>

<span class="c1">#Clear network, below is optional if the network needs to be reset</span>
<span class="c1">#net.bus.drop(net.bus.index, inplace=True)</span>
<span class="c1">#net.line.drop(net.line.index, inplace=True)</span>
<span class="c1">#net.load.drop(net.load.index, inplace=True)</span>
<span class="c1">#net.gen.drop(net.gen.index, inplace=True)</span>
<span class="c1">#net.trafo.drop(net.trafo.index, inplace=True)</span>

<span class="c1"># Update functions for transformers, buses, lines, generators, and reactive equipment</span>
<span class="k">def</span> <span class="nf">update_load_from_csv</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">load_df</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">load_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">matched_loads</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">load</span><span class="p">[(</span><span class="n">net</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_loads</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">load_index</span> <span class="o">=</span> <span class="n">matched_loads</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">net</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">load_index</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: load named </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found in the network.&quot;</span><span class="p">)</span>
            <span class="n">pp</span><span class="o">.</span><span class="n">create_load</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">bus</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;bus&#39;</span><span class="p">],</span> <span class="n">p_mw</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;p_mw&#39;</span><span class="p">],</span> <span class="n">q_mvar</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;q_mvar&#39;</span><span class="p">],</span> 
                            <span class="n">in_service</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">],</span><span class="n">scaling</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;scaling&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">update_trafo_from_csv</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">transformer_df</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">transformer_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">trafo_indices</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">trafo</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">trafo</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trafo_indices</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">trafo_index</span> <span class="o">=</span> <span class="n">trafo_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">net</span><span class="o">.</span><span class="n">trafo</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">trafo_index</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Transformer with index </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found in the network.&quot;</span><span class="p">)</span>
            <span class="n">pp</span><span class="o">.</span><span class="n">create_transformer_from_parameters</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">hv_bus</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;hv_bus&#39;</span><span class="p">],</span> <span class="n">lv_bus</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;lv_bus&#39;</span><span class="p">],</span> <span class="n">std_type</span><span class="o">=</span><span class="s2">&quot;your_standard_type&quot;</span><span class="p">,</span>
                                                  <span class="n">name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">sn_mva</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;sn_mva&#39;</span><span class="p">],</span> <span class="n">vn_hv_kv</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;vn_hv_kv&#39;</span><span class="p">],</span> <span class="n">vn_lv_kv</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;vn_lv_kv&#39;</span><span class="p">],</span>
                                                  <span class="n">vk_percent</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;vk_percent&#39;</span><span class="p">],</span> <span class="n">vkr_percent</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;vkr_percent&#39;</span><span class="p">],</span> <span class="n">pfe_kw</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pfe_kw&#39;</span><span class="p">],</span>
                                                  <span class="n">i0_percent</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;i0_percent&#39;</span><span class="p">],</span> <span class="n">shift_degree</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;shift_degree&#39;</span><span class="p">],</span> <span class="n">tap_side</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;tap_side&#39;</span><span class="p">],</span>
                                                  <span class="n">tap_neutral</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;tap_neutral&#39;</span><span class="p">],</span> <span class="n">tap_min</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;tap_min&#39;</span><span class="p">],</span> <span class="n">tap_max</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;tap_max&#39;</span><span class="p">],</span>
                                                  <span class="n">tap_step_percent</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;tap_step_percent&#39;</span><span class="p">],</span> <span class="n">tap_step_degree</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;tap_step_degree&#39;</span><span class="p">],</span>
                                                  <span class="n">tap_pos</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;tap_pos&#39;</span><span class="p">],</span> <span class="n">parallel</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;parallel&#39;</span><span class="p">],</span> <span class="n">in_service</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">],</span> 
                                                  <span class="n">max_loading_percent</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;max_loading_percent&#39;</span><span class="p">],</span><span class="n">index</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">update_bus_from_csv</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">bus_df</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">bus_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">bus_indices</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">bus</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bus_indices</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">bus_index</span> <span class="o">=</span> <span class="n">bus_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">net</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pp</span><span class="o">.</span><span class="n">create_bus</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">vn_kv</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;vn_kv&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">max_vm_pu</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;max_vm_pu&#39;</span><span class="p">],</span> <span class="n">min_vm_pu</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;min_vm_pu&#39;</span><span class="p">],</span>
                          <span class="n">zone</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;zone&#39;</span><span class="p">],</span> <span class="n">in_service</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">],</span> <span class="n">geodata</span><span class="o">=</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;y1&#39;</span><span class="p">]),</span> <span class="n">index</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">update_lines_from_csv</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">line_df</span><span class="p">,</span> <span class="n">max_i_column</span><span class="o">=</span><span class="s1">&#39;max_i_ka&#39;</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">line_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">line_indices</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;line_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line_indices</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">line_index</span> <span class="o">=</span> <span class="n">line_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">line_index</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Line with line_id </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;line_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found in the network.&quot;</span><span class="p">)</span>
            <span class="n">pp</span><span class="o">.</span><span class="n">create_line_from_parameters</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">from_bus</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;from_bus&#39;</span><span class="p">],</span> <span class="n">to_bus</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;to_bus&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;line_id&#39;</span><span class="p">],</span>
                                           <span class="n">length_km</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;length_km&#39;</span><span class="p">],</span> <span class="n">r_ohm_per_km</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;r_ohm_per_km&#39;</span><span class="p">],</span> 
                                           <span class="n">x_ohm_per_km</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;x_ohm_per_km&#39;</span><span class="p">],</span> <span class="n">c_nf_per_km</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;c_nf_per_km&#39;</span><span class="p">],</span> 
                                           <span class="n">max_i_ka</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">max_i_column</span><span class="p">],</span> <span class="n">wp_max_i_ka</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;wp_max_i_ka&#39;</span><span class="p">],</span><span class="n">name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">in_service</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">],</span> 
                                           <span class="n">max_loading_percent</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;max_loading_percent&#39;</span><span class="p">],</span><span class="n">kV</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;kv_from&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">update_generators_from_csv</span><span class="p">(</span><span class="n">net</span><span class="p">,</span><span class="n">gen_df</span><span class="p">):</span>
    <span class="c1"># Ensure custom columns exist in net.gen. Add them if needed.</span>
    <span class="k">for</span> <span class="n">custom_col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;type_&#39;</span><span class="p">,</span> <span class="s1">&#39;zone&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">custom_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="n">custom_col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># or set a default value if desired</span>
        
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gen_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">matched_generators</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_generators</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">gen_index</span> <span class="o">=</span> <span class="n">matched_generators</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">gen_index</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Generator named </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found in the network.&quot;</span><span class="p">)</span>
            <span class="n">pp</span><span class="o">.</span><span class="n">create_gen</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">bus</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;bus&#39;</span><span class="p">],</span> <span class="n">p_mw</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;p_mw&#39;</span><span class="p">],</span> <span class="n">vm_pu</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;vm_pu&#39;</span><span class="p">],</span> 
                          <span class="n">slack</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_q_mvar</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;max_q_mvar&#39;</span><span class="p">],</span> <span class="n">min_q_mvar</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;min_q_mvar&#39;</span><span class="p">],</span> 
                          <span class="n">min_p_mw</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;min_p_mw&#39;</span><span class="p">],</span> <span class="n">max_p_mw</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;max_p_mw&#39;</span><span class="p">],</span> <span class="n">in_service</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">],</span>
                          <span class="n">controllable</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;controllable&#39;</span><span class="p">],</span> <span class="n">max_vm_pu</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;max_vm_pu&#39;</span><span class="p">],</span> <span class="n">min_vm_pu</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;min_vm_pu&#39;</span><span class="p">],</span> <span class="n">type_</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                          <span class="n">zone</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;zone&#39;</span><span class="p">],</span><span class="n">scaling</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">update_reactive_from_csv</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">reactive_df</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reactive_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">matched_react</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">shunt</span><span class="p">[(</span><span class="n">net</span><span class="o">.</span><span class="n">shunt</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_react</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">react_index</span> <span class="o">=</span> <span class="n">matched_react</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">net</span><span class="o">.</span><span class="n">shunt</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">react_index</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Reactive equipment named </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found in the network.&quot;</span><span class="p">)</span>
            <span class="n">pp</span><span class="o">.</span><span class="n">create_shunt</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">bus</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;bus&#39;</span><span class="p">],</span> <span class="n">p_mw</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;p_mw&#39;</span><span class="p">],</span> <span class="n">q_mvar</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;q_mvar&#39;</span><span class="p">],</span> 
                            <span class="n">in_service</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">])</span>
            
<span class="c1">#Lines below update model if changes have been made such as new generators, lines, busses, loads, etc. . . </span>
<span class="n">update_bus_from_csv</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">bus_df</span><span class="p">)</span>
<span class="n">update_generators_from_csv</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">generator_df</span><span class="p">)</span>
<span class="n">update_lines_from_csv</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">line_df</span><span class="p">)</span>
<span class="n">update_trafo_from_csv</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">transformer_df</span><span class="p">)</span>
<span class="n">update_reactive_from_csv</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">reactive_df</span><span class="p">)</span>
<span class="n">update_load_from_csv</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">load_df_SP</span><span class="p">)</span>

<span class="n">wind_types</span> <span class="o">=</span> <span class="p">[</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">]</span>
<span class="n">all_wind_types</span> <span class="o">=</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">]</span>
<span class="n">offshore_types</span> <span class="o">=</span> <span class="p">[</span><span class="mi">16</span><span class="p">]</span>
<span class="n">gas_types</span> <span class="o">=</span> <span class="p">[</span><span class="mi">9</span><span class="p">]</span>
<span class="n">solar_types</span> <span class="o">=</span> <span class="p">[</span><span class="mi">23</span><span class="p">]</span>
<span class="n">storage_types</span> <span class="o">=</span> <span class="p">[</span><span class="mi">14</span><span class="p">]</span>
<span class="n">interconnector_type</span> <span class="o">=</span> <span class="p">[</span><span class="mi">49</span><span class="p">]</span>
<span class="n">all_re_types</span> <span class="o">=</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">]</span>
<span class="n">min_conv_units</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;  &#39;Huntstown&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;     &#39;PBEGG6&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;   &#39;AGH_CCGT&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;Knockfinglas&quot;</span><span class="p">]</span>
<span class="n">total_min_gas_max_mw</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">min_conv_units</span><span class="p">)),</span> <span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">mask_gas</span> <span class="o">=</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">gas_types</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">all_gas_pw_max</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_gas</span><span class="p">,</span> <span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">mask_offshore</span> <span class="o">=</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">all_offshore_max_pw_re</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_offshore</span><span class="p">,</span> <span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">mask_wind</span> <span class="o">=</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">wind_types</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">all_onshore_max_pw_re</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_wind</span><span class="p">,</span> <span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">mask_solar</span> <span class="o">=</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">solar_types</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">all_solar_max_pw_re</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_solar</span><span class="p">,</span> <span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">mask_storage</span> <span class="o">=</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">storage_types</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">all_storage_max_pw_re</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_storage</span><span class="p">,</span> <span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">mask_interconnector</span> <span class="o">=</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">interconnector_type</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">all_interconnector_max_pw_re</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_interconnector</span><span class="p">,</span> <span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">mask_all_re</span> <span class="o">=</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">all_re_types</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">total_re_max_pw</span> <span class="o">=</span> <span class="n">all_solar_max_pw_re</span> <span class="o">+</span> <span class="n">mask_offshore</span> <span class="o">+</span> <span class="n">mask_wind</span>

<span class="c1">#Status of generation</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total conv generation at script begin: </span><span class="si">{</span><span class="n">all_gas_pw_max</span><span class="si">}</span><span class="s2">, percentage of total: </span><span class="si">{</span><span class="p">(</span><span class="n">all_gas_pw_max</span><span class="o">/</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total offshore generation at script begin: </span><span class="si">{</span><span class="n">all_offshore_max_pw_re</span><span class="si">}</span><span class="s2">, percentage of total: </span><span class="si">{</span><span class="p">(</span><span class="n">all_offshore_max_pw_re</span><span class="o">/</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total onshore generation at script begin: </span><span class="si">{</span><span class="n">all_onshore_max_pw_re</span><span class="si">}</span><span class="s2">, percentage of total: </span><span class="si">{</span><span class="p">(</span><span class="n">all_onshore_max_pw_re</span><span class="o">/</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total solar generation at script begin: </span><span class="si">{</span><span class="n">all_solar_max_pw_re</span><span class="si">}</span><span class="s2">, percentage of total: </span><span class="si">{</span><span class="p">(</span><span class="n">all_solar_max_pw_re</span><span class="o">/</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total storage generation at script begin: </span><span class="si">{</span><span class="n">all_storage_max_pw_re</span><span class="si">}</span><span class="s2">, percentage of total: </span><span class="si">{</span><span class="p">(</span><span class="n">all_storage_max_pw_re</span><span class="o">/</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total interconnector generation at script begin: </span><span class="si">{</span><span class="n">all_interconnector_max_pw_re</span><span class="si">}</span><span class="s2">, percentage of total: </span><span class="si">{</span><span class="p">(</span><span class="n">all_interconnector_max_pw_re</span><span class="o">/</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1">#Status of load</span>
<span class="n">total_load</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span><span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total pw load: </span><span class="si">{</span><span class="n">total_load</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1">#Save network file to pickle for use</span>
<span class="n">pp</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">net</span><span class="p">,</span><span class="s2">&quot;adjusted_network.p&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.10.3
total conv generation at script begin: 5953.547500000001, percentage of total: 17.76058566483939
total offshore generation at script begin: 3641.2, percentage of total: 10.86240506568784
total onshore generation at script begin: 7803.774001, percentage of total: 23.280169790164084
total solar generation at script begin: 8932.4, percentage of total: 26.647079811257296
total storage generation at script begin: 4689.6, percentage of total: 13.989985388347165
total interconnector generation at script begin: 1700.0, percentage of total: 5.071429367150755
total pw load: 5849.0199999999995
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ─── User inputs ───────────────────────────────────────────────────────────────</span>
<span class="n">maximize_solar</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">maximize_wind</span>  <span class="o">=</span> <span class="mf">0.005</span>   <span class="c1"># give the “other” technology at least 5%</span>
<span class="n">Bess_CF</span>        <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>     <span class="c1"># no storage dispatch if negative</span>
<span class="n">tol</span>            <span class="o">=</span> <span class="mf">1e-2</span>   <span class="c1"># MW tolerance</span>
<span class="n">season</span>         <span class="o">=</span> <span class="s2">&quot;summer&quot;</span> <span class="c1">#choose &quot;summer&quot; or &quot;winter&quot; for ratings and SP or WP demand</span>
<span class="n">overshoot</span>      <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># XXX margin in MW, attempt to get wind dominant dispatches to converge</span>
<span class="c1"># ────────────────────────────────────────────────────────────────────────────────</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">from_pickle</span><span class="p">(</span><span class="s2">&quot;adjusted_network.p&quot;</span><span class="p">)</span>
<span class="n">total_load</span> <span class="o">+=</span> <span class="n">overshoot</span>
<span class="c1"># --- Build masks---</span>
<span class="n">mask_gas</span>       <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">gas_types</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span>
<span class="n">mask_min_conv</span>  <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">min_conv_units</span><span class="p">)</span>
<span class="n">mask_all_conv</span>  <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">gas_types</span><span class="p">)</span>
<span class="n">mask_storage</span>   <span class="o">=</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span>
<span class="n">mask_intercon</span>  <span class="o">=</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">49</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span>
<span class="n">mask_wind</span>      <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">all_wind_types</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span>
<span class="n">mask_offshore</span>  <span class="o">=</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span>
<span class="n">mask_solar</span>     <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">solar_types</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span>
<span class="n">mask_all_re</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">all_re_types</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span>

<span class="c1"># season update</span>
<span class="k">if</span> <span class="n">season</span> <span class="o">==</span> <span class="s2">&quot;winter&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Season updated to winter&quot;</span><span class="p">)</span>
    <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;max_i_ka&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;wp_max_i_ka&#39;</span><span class="p">]</span>
    <span class="n">update_load_from_csv</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">load_df_WP</span><span class="p">)</span>
    <span class="n">total_load</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span><span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">total_load</span> <span class="o">+=</span> <span class="n">overshoot</span>

<span class="c1"># capacities</span>
<span class="n">solar_cap</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_solar</span><span class="p">,</span>  <span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">wind_cap</span>  <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_wind</span><span class="p">,</span>   <span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="c1"># ---Dispatch must-runs ---</span>
<span class="c1"># disable all gas, then turn on minimum conv units at their min_p_mw</span>
<span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_all_conv</span><span class="p">,</span>      <span class="s1">&#39;in_service&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_min_conv</span><span class="p">,</span> <span class="s1">&#39;in_service&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_min_conv</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_min_conv</span><span class="p">,</span> <span class="s1">&#39;min_p_mw&#39;</span><span class="p">]</span>

<span class="c1"># storage</span>
<span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_storage</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_storage</span><span class="p">,</span> <span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">Bess_CF</span>

<span class="c1"># interconnectors</span>
<span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_intercon</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_intercon</span><span class="p">,</span> <span class="s1">&#39;min_p_mw&#39;</span><span class="p">]</span>

<span class="c1">#Debug</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Storage total MW: </span><span class="si">{</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_storage</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># --- Compute remaining gap after must-runs ---</span>
<span class="n">remaining_gap</span> <span class="o">=</span> <span class="n">total_load</span> <span class="o">-</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">],</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gap before RE: </span><span class="si">{</span><span class="n">remaining_gap</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MW&quot;</span><span class="p">)</span>

<span class="c1"># --- Zero-out renewables from any prior run ---</span>
<span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_solar</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_wind</span><span class="p">,</span>  <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="k">def</span> <span class="nf">dispatch_gens</span><span class="p">(</span><span class="n">remaining_gap</span><span class="p">,</span><span class="n">carry_over</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="c1"># --- Compute absolute CF caps (MW) ---</span>
    <span class="n">cap_s</span> <span class="o">=</span> <span class="n">solar_cap</span> <span class="o">*</span> <span class="n">maximize_solar</span>
    <span class="n">cap_w</span> <span class="o">=</span> <span class="n">wind_cap</span>  <span class="o">*</span> <span class="n">maximize_wind</span>
    <span class="c1">#debug</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Existing solar: </span><span class="si">{</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_solar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Existing wind: </span><span class="si">{</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_wind</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remaining gap: </span><span class="si">{</span><span class="n">remaining_gap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">remaining_gap</span> <span class="o">+=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_solar</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_wind</span><span class="p">,</span>  <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remaining gap after adding solar and wind: </span><span class="si">{</span><span class="n">remaining_gap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_solar</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_wind</span><span class="p">,</span>  <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># --- One-shot RE allocation (proportional → pour-over) ---</span>
    <span class="n">s_alloc</span> <span class="o">=</span> <span class="n">w_alloc</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">remaining_gap</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
        <span class="n">total_cap</span> <span class="o">=</span> <span class="n">cap_s</span> <span class="o">+</span> <span class="n">cap_w</span>
        <span class="c1"># proportional split</span>
        <span class="n">s_alloc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cap_s</span><span class="p">,</span> <span class="n">remaining_gap</span> <span class="o">*</span> <span class="n">cap_s</span><span class="o">/</span><span class="n">total_cap</span><span class="p">)</span>
        <span class="n">w_alloc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cap_w</span><span class="p">,</span> <span class="n">remaining_gap</span> <span class="o">*</span> <span class="n">cap_w</span><span class="o">/</span><span class="n">total_cap</span><span class="p">)</span>
        <span class="n">leftover</span> <span class="o">=</span> <span class="n">remaining_gap</span> <span class="o">-</span> <span class="p">(</span><span class="n">s_alloc</span> <span class="o">+</span> <span class="n">w_alloc</span><span class="p">)</span>
        <span class="c1">#debug</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Leftover after s and w allocation: </span><span class="si">{</span><span class="n">leftover</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># pour any leftover into the technology that still has headroom</span>
        <span class="k">if</span> <span class="n">leftover</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s_alloc</span> <span class="o">&gt;=</span> <span class="n">cap_s</span> <span class="ow">and</span> <span class="n">w_alloc</span> <span class="o">&lt;</span> <span class="n">cap_w</span><span class="p">:</span>
                <span class="n">w_alloc</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cap_w</span> <span class="o">-</span> <span class="n">w_alloc</span><span class="p">,</span> <span class="n">leftover</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">w_alloc</span> <span class="o">&gt;=</span> <span class="n">cap_w</span> <span class="ow">and</span> <span class="n">s_alloc</span> <span class="o">&lt;</span> <span class="n">cap_s</span><span class="p">:</span>
                <span class="n">s_alloc</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cap_s</span> <span class="o">-</span> <span class="n">s_alloc</span><span class="p">,</span> <span class="n">leftover</span><span class="p">)</span>

        <span class="c1"># write back</span>
        <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_solar</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_solar</span><span class="p">,</span> <span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">s_alloc</span> <span class="o">/</span> <span class="n">solar_cap</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_wind</span><span class="p">,</span>  <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_wind</span><span class="p">,</span>  <span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">w_alloc</span> <span class="o">/</span> <span class="n">wind_cap</span><span class="p">))</span>
        <span class="p">)</span>
    
        <span class="c1">#debug</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Existing solar: </span><span class="si">{</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_solar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Existing wind: </span><span class="si">{</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_wind</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">remaining_gap</span> <span class="o">=</span> <span class="n">total_load</span> <span class="o">-</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">],</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">achieved_solar_cf</span> <span class="o">=</span> <span class="n">s_alloc</span> <span class="o">/</span> <span class="n">solar_cap</span> <span class="k">if</span> <span class="n">solar_cap</span> <span class="k">else</span> <span class="mf">0.0</span>
    <span class="n">achieved_wind_cf</span>  <span class="o">=</span> <span class="n">w_alloc</span> <span class="o">/</span> <span class="n">wind_cap</span>  <span class="k">if</span> <span class="n">wind_cap</span>  <span class="k">else</span> <span class="mf">0.0</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solar CF achieved: </span><span class="si">{</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_solar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_solar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">maximize_solar</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wind   CF achieved: </span><span class="si">{</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_wind</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_wind</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">maximize_wind</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gap after RE      : </span><span class="si">{</span><span class="n">remaining_gap</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MW&quot;</span><span class="p">)</span>

    <span class="c1"># --- Dispatch gas into remaining gap ---</span>
    <span class="k">if</span> <span class="n">remaining_gap</span> <span class="o">&gt;</span> <span class="n">tol</span> <span class="ow">or</span> <span class="n">leftover</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
        <span class="n">remaining_gap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">remaining_gap</span><span class="p">,</span><span class="n">leftover</span><span class="p">)</span>
        <span class="c1"># Ramp “min_conv” units from their current p_mw up to max_p_mw</span>
        <span class="n">headroom</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_min_conv</span><span class="p">,</span> <span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_min_conv</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span>
        <span class="n">total_head</span> <span class="o">=</span> <span class="n">headroom</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">to_dispatch</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">remaining_gap</span><span class="p">,</span> <span class="n">total_head</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_head</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1">#need to proportionally distribute</span>
            <span class="c1">#debug</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;To dispatch for conventional: </span><span class="si">{</span><span class="n">to_dispatch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_min_conv</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_min_conv</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">((</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_min_conv</span><span class="p">,</span> <span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_min_conv</span><span class="p">,</span> <span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span><span class="o">*</span><span class="n">to_dispatch</span><span class="p">),</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_min_conv</span><span class="p">,</span> <span class="s1">&#39;max_p_mw&#39;</span><span class="p">])</span>
            <span class="n">remaining_gap</span> <span class="o">=</span> <span class="p">((</span><span class="n">total_load</span> <span class="o">-</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">],</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span><span class="o">+</span><span class="n">carry_over</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Min gas gens set to max dispatch, new remaining gap: </span><span class="si">{</span><span class="n">remaining_gap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># If still a gap, turn on all other gas units at their min_p_mw</span>
        <span class="k">if</span> <span class="n">remaining_gap</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;remaining gap persists after maxing out min conv gens, activating all gas gens&quot;</span><span class="p">)</span>
            <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_all_conv</span><span class="p">,</span> <span class="s1">&#39;in_service&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_all_conv</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_all_conv</span><span class="p">,</span> <span class="s1">&#39;min_p_mw&#39;</span><span class="p">]</span>
            <span class="n">remaining_gap</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_load</span> <span class="o">-</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">],</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">+</span> <span class="n">carry_over</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;remaining gap after all gas turned to min_p_mw: </span><span class="si">{</span><span class="n">remaining_gap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># If still a gap, turn on all gas units up proportionally</span>
        <span class="k">if</span> <span class="n">remaining_gap</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;remaining gap persists after activating all gas gens, adding proportional generation&quot;</span><span class="p">)</span>
            <span class="n">headroom</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_all_conv</span><span class="p">,</span> <span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_all_conv</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span>
            <span class="n">total_head</span> <span class="o">=</span> <span class="n">headroom</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">to_dispatch</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">remaining_gap</span><span class="p">,</span> <span class="n">total_head</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">total_head</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1">#need to proportionally distribute</span>
                <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_all_conv</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_all_conv</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">((</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_all_conv</span><span class="p">,</span> <span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_all_conv</span><span class="p">,</span> <span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span><span class="o">*</span><span class="n">to_dispatch</span><span class="p">),</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_all_conv</span><span class="p">,</span> <span class="s1">&#39;max_p_mw&#39;</span><span class="p">])</span>
                <span class="n">remaining_gap</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_load</span> <span class="o">-</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">],</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">+</span> <span class="n">carry_over</span>

        <span class="c1"># If overshoot (remaining_gap &lt; 0), pull back on renewables (detailed edits can allow for user to turn off gas gens to avoid this)</span>
        <span class="k">if</span> <span class="n">remaining_gap</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">tol</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overshot remaining_gap adjustment, remaining gap: </span><span class="si">{</span><span class="n">remaining_gap</span><span class="si">}</span><span class="s2"> tapering renewables to adjust&quot;</span><span class="p">)</span>
            <span class="n">total_re</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_all_re</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">reduction</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">remaining_gap</span><span class="p">,</span> <span class="o">-</span><span class="n">total_re</span><span class="p">)</span>
            <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_all_re</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_all_re</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">((</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_all_re</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_all_re</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span><span class="o">*</span><span class="n">reduction</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">remaining_gap</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_load</span> <span class="o">-</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">],</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">+</span> <span class="n">carry_over</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solar CF achieved after reduction: </span><span class="si">{</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_solar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_solar</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">maximize_solar</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wind   CF achieved after reduction: </span><span class="si">{</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_wind</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_wind</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;max_p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">maximize_wind</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">remaining_gap</span><span class="p">,</span> <span class="n">carry_over</span>
<span class="n">remaining_gap</span><span class="p">,</span> <span class="n">carry_over</span> <span class="o">=</span> <span class="n">dispatch_gens</span><span class="p">(</span><span class="n">remaining_gap</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final remaining gap: </span><span class="si">{</span><span class="n">remaining_gap</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MW&quot;</span><span class="p">)</span>

<span class="c1"># --- Overall check ---</span>
<span class="n">total_gen</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">],</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total load: </span><span class="si">{</span><span class="n">total_load</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MW, total generation: </span><span class="si">{</span><span class="n">total_gen</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MW&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Storage total MW: -4689.60
Gap before RE: 11388.33 MW
Existing solar: 0.0
Existing wind: 0.0
Remaining gap: 11388.329999999998
Remaining gap after adding solar and wind: 11388.329999999998
Leftover after s and w allocation: 3291.945129994998
Existing solar: 8039.160000000001
Existing wind: 57.224870005
Solar CF achieved: 0.900 / 0.900
Wind   CF achieved: 0.005 / 0.005
Gap after RE      : 3291.95 MW
To dispatch for conventional: 1125.2475
Min gas gens set to max dispatch, new remaining gap: 2330.238491537196
remaining gap persists after maxing out min conv gens, activating all gas gens
remaining gap after all gas turned to min_p_mw: 2304.0951299949993
remaining gap persists after activating all gas gens, adding proportional generation
Final remaining gap: 0.00 MW
Total load: 5849.02 MW, total generation: 5849.02 MW
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define power flow attempts as a list of tuples (initialization method, algorithm)</span>
<span class="n">power_flow_attempts</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1">#(&#39;flat&#39;, &#39;nr&#39;, True),   # Newton-Raphson with flat start, qlims set to true</span>
    <span class="c1">#(&#39;flat&#39;, &#39;nr&#39;, False),  # Newton-Raphson with flat start, qlims set to false</span>
    <span class="p">(</span><span class="s1">&#39;dc&#39;</span><span class="p">,</span> <span class="s1">&#39;nr&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>     <span class="c1"># Newton-Raphson with DC start, qlims set to true (most likely to solve using this)</span>
    <span class="c1">#(&#39;dc&#39;, &#39;nr&#39;, False),    # Newton-Raphson with DC start, qlims set to false</span>
<span class="p">]</span>

<span class="n">pf_settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;algorithm&quot;</span><span class="p">:</span> <span class="s1">&#39;nr&#39;</span><span class="p">,</span>
    <span class="s2">&quot;max_iteration&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s2">&quot;tolerance_mva&quot;</span><span class="p">:</span> <span class="mf">1e-5</span><span class="p">,</span>
    <span class="s2">&quot;init&quot;</span><span class="p">:</span> <span class="s1">&#39;dc&#39;</span><span class="p">,</span>
    <span class="s2">&quot;enforce_q_lims&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;calculate_voltage_angles&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;logging&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;voltage_depend_loads&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;v_debug&quot;</span><span class="p">:</span> <span class="kc">True</span>
<span class="p">}</span>

<span class="n">slack_tol</span> <span class="o">=</span> <span class="mi">40</span>          <span class="c1"># MW tolerance for slack generator output (Turlough hill equivilant of all four gens into 1, 10 MW per gen seen as reasonable)</span>
<span class="n">slack</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="k">def</span> <span class="nf">attempt_power_flow</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">attempts</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># Below is to display generation vs load balance for ROI</span>
    <span class="n">total_load</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">p_mw</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">total_generation</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Load: </span><span class="si">{</span><span class="n">total_load</span><span class="si">}</span><span class="s2"> MW, Total Generation: </span><span class="si">{</span><span class="n">total_generation</span><span class="si">}</span><span class="s2"> MW&quot;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">init_method</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span> <span class="n">q_lims</span> <span class="ow">in</span> <span class="n">attempts</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pp</span><span class="o">.</span><span class="n">runpp</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">init_method</span><span class="p">,</span> <span class="n">max_iteration</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">calculate_voltage_angles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">enforce_q_lims</span><span class="o">=</span><span class="n">q_lims</span><span class="p">,</span> <span class="n">tolerance_mva</span><span class="o">=</span><span class="mf">5e-3</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="p">,</span> <span class="n">logging</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">voltage_depend_loads</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">v_debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">net</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Power flow calculation successful with </span><span class="si">{</span><span class="n">init_method</span><span class="si">}</span><span class="s2"> start and </span><span class="si">{</span><span class="n">algorithm</span><span class="si">}</span><span class="s2"> algorithm, with q lims set to </span><span class="si">{</span><span class="n">q_lims</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Power flow did not converge, checking mismatches...&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Power flow calculation failed for </span><span class="si">{</span><span class="n">init_method</span><span class="si">}</span><span class="s2"> start </span><span class="si">{</span><span class="n">algorithm</span><span class="si">}</span><span class="s2">, with q lims set to </span><span class="si">{</span><span class="n">q_lims</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1">#Below optional to see diagnostic if powerflow fails to converge</span>
            <span class="c1">#diagnostic_results = pp.diagnostic(net, report_style=&#39;detailed&#39;)</span>
            <span class="c1">#print(diagnostic_results)</span>
    <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">compute_slack</span><span class="p">(</span><span class="n">net</span><span class="p">):</span>
    <span class="n">slack_indices</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">slack</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
    <span class="n">total_slack</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">res_gen</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;p_mw&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">slack_indices</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">total_slack</span>

<span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">slack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">slack_tol</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">attempt_power_flow</span><span class="p">(</span><span class="n">net</span><span class="p">,</span><span class="n">power_flow_attempts</span><span class="p">):</span>
        <span class="n">slack</span> <span class="o">=</span> <span class="n">compute_slack</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slack = </span><span class="si">{</span><span class="n">slack</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MW&quot;</span><span class="p">)</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="n">slack</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">slack</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">slack_tol</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convergence achieved: Slack within target range.&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Convergence not achieved: Slack: </span><span class="si">{</span><span class="n">slack</span><span class="si">}</span><span class="s2"> MW&quot;</span><span class="p">)</span>
            <span class="n">remaining_gap</span> <span class="o">=</span> <span class="n">slack</span>
            <span class="n">carry_over</span> <span class="o">=</span> <span class="n">slack</span>
            <span class="n">remaining_gap</span><span class="p">,</span><span class="n">carry_over</span> <span class="o">=</span> <span class="n">dispatch_gens</span><span class="p">(</span><span class="n">remaining_gap</span><span class="p">,</span><span class="n">carry_over</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Power flow failed to solve&quot;</span><span class="p">)</span>

    
<span class="c1">#Save network file to pickle for use</span>
<span class="n">pp</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">net</span><span class="p">,</span><span class="s2">&quot;adjusted_network.p&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total Load: 5849.0199999999995 MW, Total Generation: 5849.019999999999 MW
Power flow calculation successful with dc start and nr algorithm, with q lims set to True
Slack = 375.49 MW
Convergence not achieved: Slack: 375.49343893972764 MW
Existing solar: 8039.160000000001
Existing wind: 57.224870005
Remaining gap: 375.49343893972764
Remaining gap after adding solar and wind: 8471.878308944728
Leftover after s and w allocation: 375.49343893972764
Existing solar: 8039.160000000001
Existing wind: 57.224870005
Solar CF achieved: 0.900 / 0.900
Wind   CF achieved: 0.005 / 0.005
Gap after RE      : 0.00 MW
To dispatch for conventional: 375.49343893972764
Min gas gens set to max dispatch, new remaining gap: 44.814955259153066
remaining gap persists after maxing out min conv gens, activating all gas gens
remaining gap after all gas turned to min_p_mw: 2679.588568934727
remaining gap persists after activating all gas gens, adding proportional generation
Total Load: 5849.0199999999995 MW, Total Generation: 6224.513438939727 MW
Power flow calculation successful with dc start and nr algorithm, with q lims set to True
Slack = -4.67 MW
Convergence achieved: Slack within target range.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandapower.plotting</span>  <span class="c1"># registers the bus_geodata accessor</span>
<span class="c1">#Filter 110 kV+ buses with valid geodata for easier plotting</span>
<span class="n">filtered_buses</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">bus</span><span class="p">[</span>
    <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">bus</span><span class="p">[</span><span class="s1">&#39;vn_kv&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">110</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="n">net</span><span class="o">.</span><span class="n">bus</span><span class="p">[</span><span class="s1">&#39;geodata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
    <span class="o">&amp;</span> <span class="n">net</span><span class="o">.</span><span class="n">bus</span><span class="p">[</span><span class="s1">&#39;geodata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="p">]</span>
<span class="n">bus_ids</span> <span class="o">=</span> <span class="n">filtered_buses</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="n">net_cont</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">net</span><span class="p">)</span> <span class="c1"># Needed because contingency analysis needs reindexed buses due to out of service elements</span>
<span class="c1"># Load the bus names mapping</span>
<span class="n">bus_idx_to_name</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">net_cont</span><span class="o">.</span><span class="n">bus</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">],</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">bus</span><span class="p">[</span><span class="s1">&#39;bus_names&#39;</span><span class="p">]))</span>
<span class="c1"># Identify all buses that are not in service</span>
<span class="n">inactive_buses</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">bus</span><span class="p">[</span><span class="n">net_cont</span><span class="o">.</span><span class="n">bus</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Drop all those inactive buses (and associated elements)</span>
<span class="n">pp</span><span class="o">.</span><span class="n">drop_buses</span><span class="p">(</span><span class="n">net_cont</span><span class="p">,</span> <span class="n">inactive_buses</span><span class="p">,</span> <span class="n">drop_elements</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Ensure that bus_geodata only contains buses that are present in the bus table</span>
<span class="c1"># if bus_geodata doesn’t exist, create an empty one</span>
<span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">net_cont</span><span class="p">,</span> <span class="s2">&quot;bus_geodata&quot;</span><span class="p">):</span>
    <span class="n">net_cont</span><span class="o">.</span><span class="n">bus_geodata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">net_cont</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># otherwise filter down to only existing buses</span>
    <span class="n">net_cont</span><span class="o">.</span><span class="n">bus_geodata</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">bus_geodata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="n">net_cont</span><span class="o">.</span><span class="n">bus_geodata</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">net_cont</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="p">]</span>
<span class="n">net_cont</span><span class="o">.</span><span class="n">bus_geodata</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">bus_geodata</span><span class="p">[</span><span class="n">net_cont</span><span class="o">.</span><span class="n">bus_geodata</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">net_cont</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
<span class="c1"># Now safely call create_continuous_bus_index</span>
<span class="n">pp</span><span class="o">.</span><span class="n">create_continuous_bus_index</span><span class="p">(</span><span class="n">net_cont</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">store_old_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># Identify high-voltage buses (&gt;=110 kV)</span>
<span class="n">high_voltage_buses</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">bus</span><span class="p">[</span><span class="n">net_cont</span><span class="o">.</span><span class="n">bus</span><span class="p">[</span><span class="s1">&#39;vn_kv&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">110</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

<span class="c1"># Define contingency cases for lines and transformers</span>
<span class="n">high_voltage_long_lines</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">line</span><span class="p">[</span>
    <span class="p">(</span><span class="n">net_cont</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;from_bus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">high_voltage_buses</span><span class="p">)</span> <span class="o">|</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;to_bus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">high_voltage_buses</span><span class="p">))</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">net_cont</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;length_km&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">1.1</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">transformer_contingencies</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">trafo</span><span class="p">[</span>
    <span class="n">net_cont</span><span class="o">.</span><span class="n">trafo</span><span class="p">[</span><span class="s1">&#39;hv_bus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">high_voltage_buses</span><span class="p">)</span> <span class="o">|</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">trafo</span><span class="p">[</span><span class="s1">&#39;lv_bus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">high_voltage_buses</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">contingency_cases</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;line&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">high_voltage_long_lines</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()},</span>
    <span class="s2">&quot;trafo&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">transformer_contingencies</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
<span class="p">}</span>    

<span class="c1"># Run the contingency analysis with the defined settings</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">pp</span><span class="o">.</span><span class="n">contingency</span><span class="o">.</span><span class="n">run_contingency_ls2g</span><span class="p">(</span><span class="n">net_cont</span><span class="p">,</span> <span class="n">contingency_cases</span><span class="p">,</span> <span class="n">pp</span><span class="o">.</span><span class="n">runpp</span><span class="p">,</span> <span class="o">**</span><span class="n">pf_settings</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR - during contingency analysis: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1">#optional error handling</span>
    <span class="n">diagnostic_results</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">diagnostic</span><span class="p">(</span><span class="n">net_cont</span><span class="p">,</span> <span class="n">report_style</span><span class="o">=</span><span class="s1">&#39;detailed&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">diagnostic_results</span><span class="p">)</span>

<span class="c1"># Prepare a DataFrame for processing the results</span>
<span class="n">contingency_output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="c1"># Filter the results to include only elements in the contingency cases</span>
<span class="n">res_line_filtered</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">res_line</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">high_voltage_long_lines</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="n">res_trafo_filtered</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">res_trafo</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">transformer_contingencies</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

<span class="c1"># Ensure the line_data index is properly set</span>
<span class="k">if</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;line_id&#39;</span><span class="p">:</span>
    <span class="n">net_cont</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;line_id&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Reset index if necessary for joining</span>
<span class="k">if</span> <span class="s1">&#39;index&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_line_filtered</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">res_line_filtered</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Join line names with contingency results</span>
<span class="n">res_line_filtered</span> <span class="o">=</span> <span class="n">res_line_filtered</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">net_cont</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>

<span class="c1"># Prepare elements to process</span>
<span class="n">elements_to_process</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="n">res_line_filtered</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;trafo&quot;</span><span class="p">,</span> <span class="n">res_trafo_filtered</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">element_type</span><span class="p">,</span> <span class="n">elements</span> <span class="ow">in</span> <span class="n">elements_to_process</span><span class="p">:</span>
    <span class="c1"># Skip processing if elements DataFrame is empty</span>
    <span class="k">if</span> <span class="n">elements</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">cause_element</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cause_element&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
        <span class="n">cause_index</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cause_index&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
        <span class="n">max_loading_percent</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_loading_percent&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
        <span class="n">intact_loading_percent</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loading_percent&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
        <span class="n">element_name</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>

        <span class="c1"># Get the cause element name</span>
        <span class="k">if</span> <span class="n">cause_element</span> <span class="ow">in</span> <span class="n">net_cont</span> <span class="ow">and</span> <span class="n">cause_index</span> <span class="ow">in</span> <span class="n">net_cont</span><span class="p">[</span><span class="n">cause_element</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">cause_element_name</span> <span class="o">=</span> <span class="n">net_cont</span><span class="p">[</span><span class="n">cause_element</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">cause_index</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cause_element_name</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span>

        <span class="c1"># Append data to the contingency output DataFrame</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Element Type&quot;</span><span class="p">:</span> <span class="n">element_type</span><span class="p">,</span>
            <span class="s2">&quot;Element Index&quot;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span>
            <span class="s2">&quot;Element Name&quot;</span><span class="p">:</span> <span class="n">element_name</span><span class="p">,</span>
            <span class="s2">&quot;Intact Loading %&quot;</span><span class="p">:</span> <span class="n">intact_loading_percent</span><span class="p">,</span>
            <span class="s2">&quot;Max Loading %&quot;</span><span class="p">:</span> <span class="n">max_loading_percent</span><span class="p">,</span>
            <span class="s2">&quot;Cause Element&quot;</span><span class="p">:</span> <span class="n">cause_element</span><span class="p">,</span>
            <span class="s2">&quot;Cause Index&quot;</span><span class="p">:</span> <span class="n">cause_index</span><span class="p">,</span>
            <span class="s2">&quot;Cause Element Name&quot;</span><span class="p">:</span> <span class="n">cause_element_name</span>
        <span class="p">}</span>
        <span class="c1"># Update: Use pd.concat instead of append</span>
        <span class="n">contingency_output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">contingency_output</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">new_data</span><span class="p">])],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">net_cont</span><span class="o">.</span><span class="n">res_bus</span><span class="p">,</span> <span class="s2">&quot;min_vm_pu&quot;</span><span class="p">):</span>
    <span class="c1"># If run_contingency_ls2g stored cause info in res_bus, handle it</span>
    <span class="k">pass</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># If not, fill them as &#39;Unknown&#39;</span>
    <span class="n">net_cont</span><span class="o">.</span><span class="n">res_bus</span><span class="p">[</span><span class="s2">&quot;cause_element&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
    <span class="n">net_cont</span><span class="o">.</span><span class="n">res_bus</span><span class="p">[</span><span class="s2">&quot;cause_index&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>

<span class="c1"># create a DataFrame with relevant columns</span>
<span class="n">bus_results</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">res_bus</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">bus_results</span><span class="p">[</span><span class="s2">&quot;bus_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bus_results</span><span class="o">.</span><span class="n">index</span>

<span class="c1"># align nominal voltage</span>
<span class="n">bus_results</span><span class="p">[</span><span class="s2">&quot;vn_kv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">bus</span><span class="p">[</span><span class="s2">&quot;vn_kv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">bus_results</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="c1"># keep only buses ≥110 kV</span>
<span class="n">bus_results</span> <span class="o">=</span> <span class="n">bus_results</span><span class="p">[</span><span class="n">bus_results</span><span class="p">[</span><span class="s2">&quot;vn_kv&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">110</span><span class="p">]</span>

<span class="n">bus_results</span><span class="p">[</span><span class="s2">&quot;bus_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bus_results</span><span class="p">[</span><span class="s2">&quot;bus_idx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">bus_idx_to_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Bus_</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">bus_results</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">vm_pu</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;vm_pu&quot;</span><span class="p">]</span>
    <span class="n">max_vm_pu</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;max_vm_pu&quot;</span><span class="p">]</span>
    <span class="n">min_vm_pu</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;min_vm_pu&quot;</span><span class="p">]</span>
    <span class="n">bus_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;bus_name&quot;</span><span class="p">]</span>
    <span class="c1">#Below reflects standard operation in Irish system, voltages must stay within +/-10% and so must the voltage magnitude step after contingency</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.9</span> <span class="o">&lt;=</span> <span class="n">min_vm_pu</span> <span class="ow">or</span> <span class="n">max_vm_pu</span> <span class="o">&lt;=</span> <span class="mf">1.1</span> <span class="ow">or</span> <span class="n">max_vm_pu</span><span class="o">-</span><span class="n">vm_pu</span><span class="o">&lt;=</span><span class="mf">0.1</span> <span class="ow">or</span> <span class="n">vm_pu</span><span class="o">-</span><span class="n">min_vm_pu</span><span class="o">&lt;=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="c1"># If it&#39;s outside 0.90-1.10 p.u., record a violation</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Voltage violation detected, review contingency results&quot;</span><span class="p">)</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Element Type&quot;</span><span class="p">:</span> <span class="s2">&quot;bus&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Element Index&quot;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span>
            <span class="s2">&quot;Element Name&quot;</span><span class="p">:</span> <span class="n">bus_name</span><span class="p">,</span>
            <span class="s2">&quot;Voltage [p.u.]&quot;</span><span class="p">:</span> <span class="n">vm_pu</span><span class="p">,</span>
            <span class="s2">&quot;Max Voltage [p.u.]&quot;</span><span class="p">:</span> <span class="n">max_vm_pu</span><span class="p">,</span>
            <span class="s2">&quot;Min Voltage [p.u.]&quot;</span><span class="p">:</span> <span class="n">min_vm_pu</span><span class="p">,</span>
            <span class="c1">#&quot;Cause Element&quot;: cause_element,</span>
            <span class="c1">#&quot;Cause Index&quot;: cause_index,</span>
            <span class="c1"># We can store if it&#39;s Over/Under</span>
            <span class="s2">&quot;Violation Type&quot;</span><span class="p">:</span> <span class="s2">&quot;Under-Voltage&quot;</span> <span class="k">if</span> <span class="n">min_vm_pu</span> <span class="o">&lt;</span> <span class="mf">0.9</span> <span class="k">else</span> <span class="s2">&quot;Over-Voltage&quot;</span>
        <span class="p">}</span>
        <span class="n">contingency_output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">contingency_output</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">new_data</span><span class="p">])],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Save contingency results to CSV, optional</span>
<span class="n">contingency_output</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Results/Contingency/contingency_results_filtered_S</span><span class="si">{</span><span class="n">maximize_solar</span><span class="si">}</span><span class="s2">_W</span><span class="si">{</span><span class="n">maximize_wind</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered contingency analysis results have been saved to &#39;Results/Contingency/contingency_results_filtered_14052025.csv&#39;.&quot;</span><span class="p">)</span>


<span class="c1"># select only line‐type contingencies, edit or add new code for transformer contingencies</span>
<span class="n">line_cont</span> <span class="o">=</span> <span class="n">contingency_output</span><span class="p">[</span><span class="n">contingency_output</span><span class="p">[</span><span class="s1">&#39;Element Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">]</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">line_cont</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="c1"># find the index of the max/min “Max Loading %”</span>
    <span class="n">idx_max</span> <span class="o">=</span> <span class="n">line_cont</span><span class="p">[</span><span class="s1">&#39;Max Loading %&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
    <span class="n">idx_min</span> <span class="o">=</span> <span class="n">line_cont</span><span class="p">[</span><span class="s1">&#39;Max Loading %&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>

    <span class="n">max_row</span> <span class="o">=</span> <span class="n">line_cont</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span>
    <span class="n">min_row</span> <span class="o">=</span> <span class="n">line_cont</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_min</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Line with HIGHEST max loading: </span><span class="si">{</span><span class="n">max_row</span><span class="p">[</span><span class="s1">&#39;Element Name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">max_row</span><span class="p">[</span><span class="s1">&#39;Max Loading %&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span>
         <span class="sa">f</span><span class="s2">&quot;Caused by: </span><span class="si">{</span><span class="n">max_row</span><span class="p">[</span><span class="s1">&#39;Cause Element Name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Line with LOWEST  max loading: </span><span class="si">{</span><span class="n">min_row</span><span class="p">[</span><span class="s1">&#39;Element Name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">min_row</span><span class="p">[</span><span class="s1">&#39;Max Loading %&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span>
         <span class="sa">f</span><span class="s2">&quot;Caused by: </span><span class="si">{</span><span class="n">min_row</span><span class="p">[</span><span class="s1">&#39;Cause Element Name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No line contingencies found in results.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Filtered contingency analysis results have been saved to &#39;Results/Contingency/contingency_results_filtered_14052025.csv&#39;.
Line with HIGHEST max loading:  &#39;Derrycarney&#39; to    &#39;Derrinlough&#39; (222.7%)Caused by:  &#39;Portlaoise&#39; to  &#39;Kilcormac&#39;
Line with LOWEST  max loading: Seven Hills to Ballygar (0.0%)Caused by:    Offshore  to   &#39;Knockraha&#39;
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">Kernel</span> <span class="n">crashed</span> <span class="k">while</span> <span class="n">executing</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">current</span> <span class="n">cell</span> <span class="ow">or</span> <span class="n">a</span> <span class="n">previous</span> <span class="n">cell</span><span class="o">.</span> 

<span class="n">Please</span> <span class="n">review</span> <span class="n">the</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">cell</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">to</span> <span class="n">identify</span> <span class="n">a</span> <span class="n">possible</span> <span class="n">cause</span> <span class="n">of</span> <span class="n">the</span> <span class="n">failure</span><span class="o">.</span> 

<span class="n">Click</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s1">&#39;https://aka.ms/vscodeJupyterKernelCrash&#39;</span><span class="o">&gt;</span><span class="n">here</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">info</span><span class="o">.</span> 

<span class="n">View</span> <span class="n">Jupyter</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s1">&#39;command:jupyter.viewOutput&#39;</span><span class="o">&gt;</span><span class="n">log</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">further</span> <span class="n">details</span><span class="o">.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span><span class="p">,</span> <span class="n">prange</span>
<span class="kn">from</span> <span class="nn">pandapower.pypower.makeBdc</span> <span class="kn">import</span> <span class="n">makeBdc</span>
<span class="kn">from</span> <span class="nn">pandapower.pypower.makeLODF</span> <span class="kn">import</span> <span class="n">makeLODF</span><span class="p">,</span> <span class="n">makeOTDF</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="c1"># - - - - - - User defined thresholds - - - - - </span>
<span class="n">OVERLOAD_THRESHOLD</span> <span class="o">=</span> <span class="mi">110</span>  <span class="c1"># not in per unit (1.0 means 100% loading)</span>
<span class="n">OTDF_filter</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="c1"># filter out OTDF values that are less than this value or greater than this negative value</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">from_pickle</span><span class="p">(</span><span class="s2">&quot;adjusted_network.p&quot;</span><span class="p">)</span>
<span class="c1"># - - - - - - - - - - - - - - --- - - - - - - - </span>
<span class="k">def</span> <span class="nf">normalize_line_name</span><span class="p">(</span><span class="n">line_name</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">preprocess_network</span><span class="p">(</span><span class="n">net</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize line/trafo names and ensure consistent bus indexing in pandapower.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;name_normalized&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;name_normalized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">normalize_line_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;name_normalized&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">trafo</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">net</span><span class="o">.</span><span class="n">trafo</span><span class="p">[</span><span class="s2">&quot;name_normalized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">trafo</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">normalize_line_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;from_bus_orig&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;from_bus_orig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;from_bus&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;to_bus_orig&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;to_bus_orig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;to_bus&quot;</span><span class="p">]</span>
    <span class="n">pp</span><span class="o">.</span><span class="n">create_continuous_bus_index</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">store_old_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">orient_lines_by_flow</span><span class="p">(</span><span class="n">net</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs a DC power flow, then re-orients each line if its flow is negative.</span>
<span class="sd">    Re-runs DC to update flows.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pp</span><span class="o">.</span><span class="n">runpp</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">**</span><span class="n">pf_settings</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">p_from</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">res_line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;p_from_mw&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">p_from</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">old_from</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;from_bus&quot;</span><span class="p">]</span>
            <span class="n">old_to</span>   <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;to_bus&quot;</span><span class="p">]</span>
            <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;from_bus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_to</span>
            <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;to_bus&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">old_from</span>
    <span class="n">pp</span><span class="o">.</span><span class="n">runpp</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">**</span><span class="n">pf_settings</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">map_branch_indices</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">orig_branch_idx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map each HV branch in the subnetwork to its original pandapower index.</span>
<span class="sd">    For lines, return the net.line index; for transformers, return the net.trafo index.</span>
<span class="sd">    Also returns a list indicating branch type (&quot;line&quot;, &quot;trafo&quot;, or &quot;unknown&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">branch_lookup</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">_pd2ppc_lookups</span><span class="p">[</span><span class="s2">&quot;branch&quot;</span><span class="p">]</span>
    <span class="n">line_range</span> <span class="o">=</span> <span class="n">branch_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">line_start</span><span class="p">,</span> <span class="n">line_end</span> <span class="o">=</span> <span class="n">line_range</span>
    <span class="n">net_line_indices</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    
    <span class="n">trafo_range</span> <span class="o">=</span> <span class="n">branch_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trafo&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">trafo_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">trafo_start</span><span class="p">,</span> <span class="n">trafo_end</span> <span class="o">=</span> <span class="n">trafo_range</span>
        <span class="n">net_trafo_indices</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">trafo</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">trafo_start</span><span class="p">,</span> <span class="n">trafo_end</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">net_trafo_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    
    <span class="n">mapped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orig_branch_idx</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">mapped_type</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orig_branch_idx</span><span class="p">))]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ppc_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">orig_branch_idx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line_start</span> <span class="o">&lt;=</span> <span class="n">ppc_idx</span> <span class="o">&lt;</span> <span class="n">line_end</span><span class="p">:</span>
            <span class="n">mapped</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">net_line_indices</span><span class="p">[</span><span class="n">ppc_idx</span> <span class="o">-</span> <span class="n">line_start</span><span class="p">]</span>
            <span class="n">mapped_type</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;line&quot;</span>
        <span class="k">elif</span> <span class="n">trafo_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">trafo_start</span> <span class="o">&lt;=</span> <span class="n">ppc_idx</span> <span class="o">&lt;</span> <span class="n">trafo_end</span><span class="p">:</span>
            <span class="n">mapped</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">net_trafo_indices</span><span class="p">[</span><span class="n">ppc_idx</span> <span class="o">-</span> <span class="n">trafo_start</span><span class="p">]</span>
            <span class="n">mapped_type</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;trafo&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mapped</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">mapped_type</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="k">return</span> <span class="n">mapped</span><span class="p">,</span> <span class="n">mapped_type</span>

<span class="k">def</span> <span class="nf">compute_base_loading_vectorized</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">branch_array</span><span class="p">,</span> <span class="n">orig_branch_idx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vectorized computation of base loading for each branch.</span>
<span class="sd">    For lines, use net.line[&quot;max_i_ka&quot;]; for transformers, use net.trafo[&quot;sn_mva&quot;].</span>
<span class="sd">    Converts DataFrame indices to positional indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mapped_branch_idx</span><span class="p">,</span> <span class="n">mapped_type</span> <span class="o">=</span> <span class="n">map_branch_indices</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">orig_branch_idx</span><span class="p">)</span>
    <span class="n">mapped_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mapped_type</span><span class="p">)</span>
    <span class="n">mapped_branch_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mapped_branch_idx</span><span class="p">)</span>
    <span class="n">n_br</span> <span class="o">=</span> <span class="n">branch_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">base_loading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_br</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="n">line_positions</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">:</span> <span class="n">pos</span> <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">)}</span>
    <span class="n">trafo_positions</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">:</span> <span class="n">pos</span> <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">trafo</span><span class="o">.</span><span class="n">index</span><span class="p">)}</span>
    
    <span class="n">line_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mapped_type</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mapped_branch_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">line_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">line_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">line_positions</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mapped_branch_idx</span><span class="p">[</span><span class="n">line_mask</span><span class="p">]])</span>
        <span class="n">line_values</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">res_line</span><span class="p">[</span><span class="s2">&quot;loading_percent&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">base_loading</span><span class="p">[</span><span class="n">line_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_values</span><span class="p">[</span><span class="n">line_indices</span><span class="p">]</span>
    
    <span class="n">trafo_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mapped_type</span> <span class="o">==</span> <span class="s2">&quot;trafo&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mapped_branch_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">trafo_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">trafo_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">trafo_positions</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mapped_branch_idx</span><span class="p">[</span><span class="n">trafo_mask</span><span class="p">]])</span>
        <span class="n">trafo_values</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">res_trafo</span><span class="p">[</span><span class="s2">&quot;loading_percent&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">base_loading</span><span class="p">[</span><span class="n">trafo_mask</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">trafo_values</span><span class="p">[</span><span class="n">trafo_indices</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.25</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">OVERLOAD_THRESHOLD</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>  <span class="c1"># Transformer allowed up to 125%</span>
    
    <span class="k">return</span> <span class="n">base_loading</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">clip_and_replace_parallel</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">clip_min</span><span class="p">,</span> <span class="n">clip_max</span><span class="p">):</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">clip_min</span><span class="p">:</span>
                <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">clip_min</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">clip_max</span><span class="p">:</span>
                <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">clip_max</span>
    <span class="k">return</span> <span class="n">matrix</span>

<span class="k">def</span> <span class="nf">reindex_bus_ids</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">bus_array</span><span class="p">,</span> <span class="n">branch_array</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Re‐maps bus IDs in the ppc arrays to a contiguous 0..(n-1) range,</span>
<span class="sd">    and returns mappings back to the *original* pandapower bus indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">bus_array</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">branch_array</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">bus_array</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">bus_array</span><span class="p">,</span> <span class="n">branch_array</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{}</span>

    <span class="c1">#Grab the pandapower→ppc lookup, which may be a dict or a 1D np.array</span>
    <span class="n">pp_lookup</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">_pd2ppc_lookups</span><span class="p">[</span><span class="s2">&quot;bus&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pp_lookup</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">bus2ppc</span> <span class="o">=</span> <span class="n">pp_lookup</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pp_lookup</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="c1"># array[pd_idx] = ppc_idx</span>
        <span class="n">bus2ppc</span> <span class="o">=</span> <span class="p">{</span><span class="n">pd_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">ppc_idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">pd_idx</span><span class="p">,</span> <span class="n">ppc_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pp_lookup</span><span class="p">)}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected type for pd2ppc bus lookup: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">pp_lookup</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1">#Invert it: ppc_idx → pandapower bus_idx</span>
    <span class="n">ppc_to_bus</span> <span class="o">=</span> <span class="p">{</span><span class="n">ppc</span><span class="p">:</span> <span class="n">bus</span> <span class="k">for</span> <span class="n">bus</span><span class="p">,</span> <span class="n">ppc</span> <span class="ow">in</span> <span class="n">bus2ppc</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="c1">#Pull the original ppc‐bus indices out of the first column of bus_array</span>
    <span class="n">old_ppc_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">bus_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">old_bus_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ppc_to_bus</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ppc</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">ppc</span> <span class="ow">in</span> <span class="n">old_ppc_ids</span><span class="p">])</span>

    <span class="c1">#Build your new 0..N-1 IDs</span>
    <span class="n">n_buses</span>    <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_bus_ids</span><span class="p">)</span>
    <span class="n">new_ids</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_buses</span><span class="p">)</span>
    <span class="n">new_to_old</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">new_ids</span><span class="p">,</span> <span class="n">old_bus_ids</span><span class="p">))</span>
    <span class="n">old_to_new</span> <span class="o">=</span> <span class="p">{</span><span class="n">old</span><span class="p">:</span> <span class="n">new</span> <span class="k">for</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span> <span class="ow">in</span> <span class="n">new_to_old</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">old</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">}</span>

    <span class="c1">#Overwrite bus_array’s first column with the new contiguous IDs</span>
    <span class="n">bus_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_ids</span>

    <span class="c1">#Now update the branch_array’s from/to to use new IDs as well</span>
    <span class="n">from_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">branch_array</span><span class="p">[:,</span> <span class="n">F_BUS</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">to_b</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">branch_array</span><span class="p">[:,</span> <span class="n">T_BUS</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">branch_array</span><span class="p">)):</span>
        <span class="n">ppc_from</span> <span class="o">=</span> <span class="n">from_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ppc_to</span>   <span class="o">=</span> <span class="n">to_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">old_from</span> <span class="o">=</span> <span class="n">ppc_to_bus</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ppc_from</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">old_to</span>   <span class="o">=</span> <span class="n">ppc_to_bus</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ppc_to</span><span class="p">,</span>   <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">branch_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">F_BUS</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_to_new</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">old_from</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">branch_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">T_BUS</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_to_new</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">old_to</span><span class="p">,</span>   <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bus_array</span><span class="p">,</span> <span class="n">branch_array</span><span class="p">,</span> <span class="n">new_to_old</span><span class="p">,</span> <span class="n">old_to_new</span>


<span class="k">def</span> <span class="nf">build_hv_only_ppc</span><span class="p">(</span><span class="n">net</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs AC power flow, orients lines, and extracts ppc arrays (bus, branch)</span>
<span class="sd">    for HV buses (vn_kv &gt;= 110) plus any slack buses.</span>
<span class="sd">    Additionally excludes pandapower lines where length_km &lt; 1.</span>
<span class="sd">    Further filters to include only &quot;meshed&quot; HV buses.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pp</span><span class="o">.</span><span class="n">runpp</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">**</span><span class="n">pf_settings</span><span class="p">)</span>
    
    <span class="n">ppc</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">_ppc</span>
    <span class="k">if</span> <span class="s2">&quot;bus&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ppc</span> <span class="ow">or</span> <span class="s2">&quot;branch&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ppc</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Error] Missing ppc bus or branch.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">bus_array</span> <span class="o">=</span> <span class="n">ppc</span><span class="p">[</span><span class="s2">&quot;bus&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">branch_array</span> <span class="o">=</span> <span class="n">ppc</span><span class="p">[</span><span class="s2">&quot;branch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Identify HV buses based on voltage (&gt;= 110 kV)</span>
    <span class="n">hv_buses</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">bus</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">bus</span><span class="p">[</span><span class="s2">&quot;vn_kv&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">110</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">slack_buses</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s2">&quot;slack&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">values</span>
    <span class="k">for</span> <span class="n">sb</span> <span class="ow">in</span> <span class="n">slack_buses</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sb</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hv_buses</span><span class="p">:</span>
            <span class="n">hv_buses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span>

    <span class="c1"># Filter to only &quot;meshed&quot; buses.</span>
    <span class="n">line_from</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;from_bus&quot;</span><span class="p">]</span>
    <span class="n">line_to</span>   <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;to_bus&quot;</span><span class="p">]</span>
    <span class="n">mask_from</span> <span class="o">=</span> <span class="n">line_from</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">hv_buses</span><span class="p">)</span>
    <span class="n">mask_to</span>   <span class="o">=</span> <span class="n">line_to</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">hv_buses</span><span class="p">)</span>
    <span class="n">lines_in_hv</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="n">mask_from</span> <span class="o">&amp;</span> <span class="n">mask_to</span><span class="p">]</span>
    <span class="n">line_connections</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">lines_in_hv</span><span class="p">[</span><span class="s2">&quot;from_bus&quot;</span><span class="p">],</span> <span class="n">lines_in_hv</span><span class="p">[</span><span class="s2">&quot;to_bus&quot;</span><span class="p">]])</span>
    <span class="n">line_counts</span> <span class="o">=</span> <span class="n">line_connections</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;trafo&quot;</span> <span class="ow">in</span> <span class="n">net</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">net</span><span class="o">.</span><span class="n">trafo</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">trafo_counts</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">trafo</span><span class="p">[</span><span class="s2">&quot;hv_bus&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">trafo_counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">connectivity</span> <span class="o">=</span> <span class="n">line_counts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">trafo_counts</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">meshed_hv_buses</span> <span class="o">=</span> <span class="p">[</span><span class="n">bus</span> <span class="k">for</span> <span class="n">bus</span> <span class="ow">in</span> <span class="n">hv_buses</span> <span class="k">if</span> <span class="n">connectivity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">hv_buses</span> <span class="o">=</span> <span class="n">meshed_hv_buses</span>

    <span class="n">bus_lookup</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">_pd2ppc_lookups</span><span class="p">[</span><span class="s2">&quot;bus&quot;</span><span class="p">]</span>
    <span class="n">hv_ppc_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">bus_lookup</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">hv_buses</span> <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bus_lookup</span><span class="p">]</span>

    <span class="n">mask_bus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">bus_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">hv_ppc_idx</span><span class="p">)</span>
    <span class="n">bus_array</span> <span class="o">=</span> <span class="n">bus_array</span><span class="p">[</span><span class="n">mask_bus</span><span class="p">,</span> <span class="p">:]</span>

    <span class="n">from_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">branch_array</span><span class="p">[:,</span> <span class="n">F_BUS</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">to_b</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">branch_array</span><span class="p">[:,</span> <span class="n">T_BUS</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">mask_hv_br</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">from_b</span><span class="p">,</span> <span class="n">hv_ppc_idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">to_b</span><span class="p">,</span> <span class="n">hv_ppc_idx</span><span class="p">)</span>

    <span class="n">line_start</span><span class="p">,</span> <span class="n">line_end</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">_pd2ppc_lookups</span><span class="p">[</span><span class="s2">&quot;branch&quot;</span><span class="p">][</span><span class="s2">&quot;line&quot;</span><span class="p">]</span>
    <span class="n">line_ppc_indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">line_start</span><span class="p">,</span> <span class="n">line_end</span><span class="p">)</span>
    <span class="n">line_pp_indices</span>  <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">ppc_idx_to_line_idx</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">line_ppc_indices</span><span class="p">,</span> <span class="n">line_pp_indices</span><span class="p">))</span>
    <span class="n">short_line_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;length_km&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.1</span><span class="p">)</span>
    <span class="n">short_line_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="n">short_line_mask</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">mask_short_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">branch_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ppc_idx</span> <span class="ow">in</span> <span class="n">line_ppc_indices</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ppc_idx</span> <span class="ow">in</span> <span class="n">ppc_idx_to_line_idx</span><span class="p">:</span>
            <span class="n">pandapower_line_idx</span> <span class="o">=</span> <span class="n">ppc_idx_to_line_idx</span><span class="p">[</span><span class="n">ppc_idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pandapower_line_idx</span> <span class="ow">in</span> <span class="n">short_line_idx</span><span class="p">:</span>
                <span class="n">mask_short_line</span><span class="p">[</span><span class="n">ppc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">mask_br</span> <span class="o">=</span> <span class="n">mask_hv_br</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">mask_short_line</span><span class="p">)</span>
    <span class="n">orig_branch_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_br</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">branch_array</span> <span class="o">=</span> <span class="n">branch_array</span><span class="p">[</span><span class="n">mask_br</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">return</span> <span class="n">bus_array</span><span class="p">,</span> <span class="n">branch_array</span><span class="p">,</span> <span class="n">orig_branch_idx</span>

<span class="k">def</span> <span class="nf">compute_PTDF_LODF_OTDF</span><span class="p">(</span><span class="n">net</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Builds an HV-only ppc subnetwork, reindexes bus IDs, then computes PTDF, LODF, and OTDF.</span>
<span class="sd">    Returns (H, L, OTDF, bus_array, branch_array, new_to_old, orig_branch_idx, old_to_new).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bus_array</span><span class="p">,</span> <span class="n">branch_array</span><span class="p">,</span> <span class="n">orig_branch_idx</span> <span class="o">=</span> <span class="n">build_hv_only_ppc</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bus_array</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">branch_array</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">bus_array</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">branch_array</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">bus_array</span><span class="p">,</span> <span class="n">branch_array</span><span class="p">,</span> <span class="n">new_to_old</span><span class="p">,</span> <span class="n">old_to_new</span> <span class="o">=</span> <span class="n">reindex_bus_ids</span><span class="p">(</span><span class="n">net</span><span class="p">,</span><span class="n">bus_array</span><span class="p">,</span> <span class="n">branch_array</span><span class="p">)</span>
    
    <span class="n">Bbus</span><span class="p">,</span> <span class="n">Bf</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">makeBdc</span><span class="p">(</span><span class="n">bus_array</span><span class="p">,</span> <span class="n">branch_array</span><span class="p">)</span>
    <span class="n">Bbus</span> <span class="o">=</span> <span class="n">Bbus</span><span class="o">.</span><span class="n">tocsc</span><span class="p">()</span>
    <span class="n">Bf</span>   <span class="o">=</span> <span class="n">Bf</span><span class="o">.</span><span class="n">tocsc</span><span class="p">()</span>

    <span class="n">reg_factor</span> <span class="o">=</span> <span class="mf">1e-4</span>
    <span class="n">Bbus_dense</span> <span class="o">=</span> <span class="n">Bbus</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span> <span class="o">+</span> <span class="n">reg_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">Bbus</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cond_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">Bbus_dense</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cond_num</span> <span class="o">&lt;</span> <span class="mf">1e12</span><span class="p">:</span>
            <span class="n">invBbus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Bbus_dense</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">Bbus_dense</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;High condition number; using pseudoinverse.&quot;</span><span class="p">)</span>
            <span class="n">invBbus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">Bbus_dense</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">LinAlgError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;B matrix inversion error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">invBbus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">Bbus_dense</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
    
    <span class="n">PTDF_mat</span> <span class="o">=</span> <span class="n">Bf</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">invBbus</span><span class="p">)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">PTDF_mat</span><span class="p">)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">clip_and_replace_parallel</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="n">L</span> <span class="o">=</span> <span class="n">makeLODF</span><span class="p">(</span><span class="n">branch_array</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">posinf</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=-</span><span class="mf">1e6</span><span class="p">)</span>
    
    <span class="n">n_br</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">outage_branches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_br</span><span class="p">)</span>
    <span class="n">OTDF_raw</span> <span class="o">=</span> <span class="n">makeOTDF</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">outage_branches</span><span class="p">)</span>
    <span class="n">OTDF_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">OTDF_raw</span><span class="p">)</span>
    <span class="n">OTDF_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">OTDF_raw</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">posinf</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=-</span><span class="mf">1e6</span><span class="p">)</span>
    <span class="n">OTDF</span> <span class="o">=</span> <span class="n">clip_and_replace_parallel</span><span class="p">(</span><span class="n">OTDF_raw</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e6</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">H</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">OTDF</span><span class="p">,</span> <span class="n">bus_array</span><span class="p">,</span> <span class="n">branch_array</span><span class="p">,</span> <span class="n">new_to_old</span><span class="p">,</span> <span class="n">orig_branch_idx</span><span class="p">,</span> <span class="n">old_to_new</span>

<span class="n">batch_contingency</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">preprocess_network</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
<span class="n">orient_lines_by_flow</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>

<span class="c1"># Build debug dictionary for circuit info.</span>
<span class="n">circuit_info</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">line_idx</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="n">ln_name</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">line_idx</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="n">fb_orig</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">line_idx</span><span class="p">,</span> <span class="s2">&quot;from_bus_orig&quot;</span><span class="p">]</span>
    <span class="n">tb_orig</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">line_idx</span><span class="p">,</span> <span class="s2">&quot;to_bus_orig&quot;</span><span class="p">]</span>
    <span class="n">circuit_info</span><span class="p">[</span><span class="n">line_idx</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">ln_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
<span class="n">H</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">OTDF</span><span class="p">,</span> <span class="n">topo_bus_array</span><span class="p">,</span> <span class="n">topo_branch_array</span><span class="p">,</span> <span class="n">new_to_old</span><span class="p">,</span> <span class="n">orig_branch_idx</span><span class="p">,</span> <span class="n">old_to_new</span> <span class="o">=</span> <span class="n">compute_PTDF_LODF_OTDF</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
<span class="n">n_br</span><span class="p">,</span> <span class="n">n_bus</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">shape</span>

<span class="n">sample_new_to_old</span> <span class="o">=</span> <span class="n">new_to_old</span>

<span class="c1"># Compute injection-dependent base loadings.</span>
<span class="n">base_loading</span> <span class="o">=</span> <span class="n">compute_base_loading_vectorized</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">topo_branch_array</span><span class="p">,</span> <span class="n">orig_branch_idx</span><span class="p">)</span>

<span class="c1"># Recalculate loading matrix with updated injections.</span>
<span class="n">loading_matrix</span> <span class="o">=</span> <span class="n">base_loading</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">L</span> <span class="o">*</span> <span class="n">base_loading</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
<span class="n">loading_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">loading_matrix</span><span class="p">)</span>

<span class="c1"># Map branches.</span>
<span class="n">mapped_branch_idx</span><span class="p">,</span> <span class="n">mapped_type</span> <span class="o">=</span> <span class="n">map_branch_indices</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">orig_branch_idx</span><span class="p">)</span>

<span class="c1"># Recompute max loading values.</span>
<span class="n">max_loading_values</span> <span class="o">=</span> <span class="n">loading_matrix</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">max_loading_indices</span> <span class="o">=</span> <span class="n">loading_matrix</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">line_idx_set</span>  <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">net_cont</span><span class="o">.</span><span class="n">res_line</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">trafo_idx_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">net_cont</span><span class="o">.</span><span class="n">res_trafo</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="c1"># Build per-file contingency data.</span>
<span class="n">cont_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_br</span><span class="p">)</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_br</span><span class="p">):</span>
    <span class="n">net_branch_idx</span> <span class="o">=</span> <span class="n">mapped_branch_idx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
    <span class="n">branch_type</span> <span class="o">=</span> <span class="n">mapped_type</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">branch_type</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span> <span class="ow">and</span> <span class="n">net_branch_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">branch_name</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">intact_loading_pct</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">res_line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;loading_percent&quot;</span><span class="p">]</span>
        <span class="n">max_ia_loading</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;max_i_ka&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">net_branch_idx</span> <span class="ow">in</span> <span class="n">line_idx_set</span><span class="p">:</span>
            <span class="n">i_star</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">res_line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;cause_index&quot;</span><span class="p">]</span>
            <span class="n">max_loading_fraction</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">res_line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;max_loading_percent&quot;</span><span class="p">]</span>
            <span class="n">cont_max</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">res_line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;max_loading_percent&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i_star</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">max_loading_fraction</span> <span class="o">=</span> <span class="n">intact_loading_pct</span>
            <span class="n">cont_max</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">intact_loading_pct</span>
    <span class="k">elif</span> <span class="n">branch_type</span> <span class="o">==</span> <span class="s2">&quot;trafo&quot;</span> <span class="ow">and</span> <span class="n">net_branch_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">branch_name</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">trafo</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">intact_loading_pct</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">res_trafo</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;loading_percent&quot;</span><span class="p">]</span>
        <span class="n">max_ia_loading</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">trafo</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;sn_mva&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">net_branch_idx</span> <span class="ow">in</span> <span class="n">trafo_idx_set</span><span class="p">:</span>
            <span class="n">i_star</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">res_trafo</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;cause_index&quot;</span><span class="p">]</span>
            <span class="n">max_loading_fraction</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">res_trafo</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;max_loading_percent&quot;</span><span class="p">]</span>
            <span class="n">cont_max</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">res_trafo</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;max_loading_percent&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i_star</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">max_loading_fraction</span> <span class="o">=</span> <span class="n">intact_loading_pct</span>
            <span class="n">cont_max</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">intact_loading_pct</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">branch_name</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
        <span class="n">intact_loading_pct</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">max_ia_loading</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">i_star</span> <span class="o">=</span> <span class="n">max_loading_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">cont_max</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">outage_name</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
    <span class="k">if</span> <span class="n">i_star</span> <span class="o">&lt;</span> <span class="n">n_br</span><span class="p">:</span>
        <span class="n">o_net_branch_idx</span> <span class="o">=</span> <span class="n">mapped_branch_idx</span><span class="p">[</span><span class="n">i_star</span><span class="p">]</span>
        <span class="n">o_branch_type</span> <span class="o">=</span> <span class="n">mapped_type</span><span class="p">[</span><span class="n">i_star</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">o_net_branch_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">o_branch_type</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">:</span>
                <span class="n">outage_name</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">o_net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">o_branch_type</span> <span class="o">==</span> <span class="s2">&quot;trafo&quot;</span><span class="p">:</span>
                <span class="n">outage_name</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">trafo</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">o_net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="n">batch_contingency</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">branch_name</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">(</span><span class="n">intact_loading_pct</span><span class="p">,</span> <span class="n">max_loading_fraction</span><span class="p">,</span> <span class="n">outage_name</span><span class="p">)</span>
    <span class="p">)</span>

<span class="c1"># --- Optimized Aggregation Loop for OTDF Contributions ---</span>
<span class="c1">#threshold_idx = np.where(max_loading_values &gt;= OVERLOAD_THRESHOLD)[0]</span>
<span class="c1"># now pick only those branches whose worst‐case loading ≥ OVERLOAD_THRESHOLD</span>
<span class="n">threshold_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cont_max</span> <span class="o">&gt;=</span> <span class="n">OVERLOAD_THRESHOLD</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">contrib_records</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list to accumulate tuples of (orig_bus_id, contribution, circuit_debug)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">res_bus</span><span class="p">[</span><span class="s2">&quot;p_mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">res_bus</span><span class="p">[</span><span class="s2">&quot;q_mvar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">bus_injection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">threshold_idx</span><span class="p">:</span>
    <span class="n">net_branch_idx</span> <span class="o">=</span> <span class="n">mapped_branch_idx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
    <span class="n">branch_type</span> <span class="o">=</span> <span class="n">mapped_type</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">net_branch_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">branch_type</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">:</span>
            <span class="n">circuit_debug</span> <span class="o">=</span> <span class="n">circuit_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;UnknownCircuit&quot;</span><span class="p">)</span>
            <span class="n">circuit_rating</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s1">&#39;max_i_ka&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s1">&#39;kv_from&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1.732</span>
            <span class="n">scaling_factor</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">res_line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;max_loading_percent&quot;</span><span class="p">]</span>
            <span class="n">i_star</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">res_line</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;cause_index&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">branch_type</span> <span class="o">==</span> <span class="s2">&quot;trafo&quot;</span><span class="p">:</span>
            <span class="n">circuit_debug</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Transformer: </span><span class="si">{</span><span class="n">net</span><span class="o">.</span><span class="n">trafo</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">circuit_rating</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">trafo</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s1">&#39;sn_mva&#39;</span><span class="p">]</span>
            <span class="n">scaling_factor</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">res_trafo</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;max_loading_percent&quot;</span><span class="p">]</span>
            <span class="n">i_star</span> <span class="o">=</span> <span class="n">net_cont</span><span class="o">.</span><span class="n">res_trafo</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">net_branch_idx</span><span class="p">,</span> <span class="s2">&quot;cause_index&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">circuit_debug</span> <span class="o">=</span> <span class="s2">&quot;UnknownCircuit&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">circuit_debug</span> <span class="o">=</span> <span class="s2">&quot;UnknownCircuit&quot;</span>

    <span class="n">i_star_x</span> <span class="o">=</span> <span class="n">max_loading_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">i_star_x</span> <span class="o">*</span> <span class="n">n_br</span> <span class="o">+</span> <span class="n">j</span>
    <span class="n">Xj_unscaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">OTDF</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="p">:])</span>
    <span class="c1">#scaling_factor = max_loading_values[j]</span>
    <span class="n">mva_loading_over</span> <span class="o">=</span> <span class="p">((</span><span class="n">scaling_factor</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">circuit_rating</span><span class="p">)</span> <span class="o">-</span> <span class="n">circuit_rating</span>
    <span class="c1">#Xj = Xj_unscaled * scaling_factor</span>

    <span class="n">nz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Xj_unscaled</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">OTDF_filter</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Accumulate contributions for all buses at once</span>
    <span class="k">for</span> <span class="n">b_idx</span> <span class="ow">in</span> <span class="n">nz</span><span class="p">:</span>
        <span class="n">orig_bus_id</span> <span class="o">=</span> <span class="n">new_to_old</span><span class="p">[</span><span class="n">b_idx</span><span class="p">]</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">Xj_unscaled</span><span class="p">[</span><span class="n">b_idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">scaling_factor</span>
        <span class="n">mva_reduction</span> <span class="o">=</span> <span class="n">Xj_unscaled</span><span class="p">[</span><span class="n">b_idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">mva_loading_over</span>
        <span class="n">inj</span> <span class="o">=</span> <span class="n">bus_injection</span><span class="p">[</span><span class="n">orig_bus_id</span><span class="p">]</span>
        <span class="n">pct_of_injection</span> <span class="o">=</span> <span class="p">(</span><span class="n">mva_reduction</span> <span class="o">/</span> <span class="n">inj</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="k">if</span> <span class="n">inj</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="n">mva_reduction</span> <span class="o">/</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="c1">#assumes buses with no injection inject at least 1 MVA</span>
        <span class="n">bus_name</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">bus</span><span class="p">[</span><span class="s1">&#39;bus_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">orig_bus_id</span><span class="p">]</span>
        <span class="n">contrib_records</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">orig_bus_id</span><span class="p">,</span><span class="n">bus_name</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">scaling_factor</span><span class="p">,</span> <span class="n">circuit_debug</span><span class="p">,</span><span class="n">pct_of_injection</span><span class="p">))</span>

<span class="c1"># Convert the records to a DataFrame for efficient grouping.</span>
<span class="n">df_contrib</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">contrib_records</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Bus_ID&quot;</span><span class="p">,</span><span class="s2">&quot;Bus_Name&quot;</span><span class="p">,</span> <span class="s2">&quot;Scaled Contribution&quot;</span><span class="p">,</span><span class="s2">&quot;Cont_Loading&quot;</span><span class="p">,</span><span class="s2">&quot;Circuit_Debug&quot;</span><span class="p">,</span><span class="s2">&quot;Percent Reduction&quot;</span><span class="p">])</span>

<span class="c1"># ─── use single contributions DataFrame (df_contrib) ─────────────────────────</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df_contrib</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Scaled Contribution&#39;</span><span class="p">:</span><span class="s1">&#39;scaled_OTDF_Contribution&#39;</span><span class="p">})</span>

<span class="c1"># ─── compute the five summary stats, user can change as needed────────────────────</span>
<span class="n">statss</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Bus_ID&#39;</span><span class="p">,</span><span class="s1">&#39;Bus_Name&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;scaled_OTDF_Contribution&#39;</span><span class="p">]</span>
      <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
          <span class="n">Cum_sOTDF</span> <span class="o">=</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
          <span class="n">Avg_sOTDF</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
          <span class="n">Med_sOTDF</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span>
          <span class="n">Max_sOTDF</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span>
          <span class="n">Min_sOTDF</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>
      <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># ─── find the Circuit_Debug at the max/min contribution ─────────────────────────</span>
<span class="n">idxmax</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Bus_ID&#39;</span><span class="p">,</span><span class="s1">&#39;Bus_Name&#39;</span><span class="p">])[</span><span class="s1">&#39;scaled_OTDF_Contribution&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
<span class="n">idxmin</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Bus_ID&#39;</span><span class="p">,</span><span class="s1">&#39;Bus_Name&#39;</span><span class="p">])[</span><span class="s1">&#39;scaled_OTDF_Contribution&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>

<span class="n">circ_max</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idxmax</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Bus_ID&#39;</span><span class="p">,</span><span class="s1">&#39;Bus_Name&#39;</span><span class="p">,</span><span class="s1">&#39;Circuit_Debug&#39;</span><span class="p">,</span><span class="s1">&#39;scaled_OTDF_Contribution&#39;</span><span class="p">,</span><span class="s2">&quot;Cont_Loading&quot;</span><span class="p">,</span><span class="s1">&#39;Percent Reduction&#39;</span><span class="p">]]</span>
      <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
          <span class="s1">&#39;Circuit_Debug&#39;</span><span class="p">:</span><span class="s1">&#39;Circuit_Involved_max&#39;</span><span class="p">,</span>
          <span class="s1">&#39;scaled_OTDF_Contribution&#39;</span><span class="p">:</span><span class="s1">&#39;Scaled_OTDF_Contribution_max&#39;</span><span class="p">,</span>
          <span class="s1">&#39;Percent Reduction&#39;</span><span class="p">:</span> <span class="s1">&#39;Percent Reduction_max&#39;</span>
      <span class="p">})</span>
<span class="p">)</span>
<span class="n">circ_min</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idxmin</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Bus_ID&#39;</span><span class="p">,</span><span class="s1">&#39;Bus_Name&#39;</span><span class="p">,</span><span class="s1">&#39;Circuit_Debug&#39;</span><span class="p">,</span><span class="s1">&#39;scaled_OTDF_Contribution&#39;</span><span class="p">,</span><span class="s2">&quot;Cont_Loading&quot;</span><span class="p">,</span><span class="s1">&#39;Percent Reduction&#39;</span><span class="p">]]</span>
      <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
          <span class="s1">&#39;Circuit_Debug&#39;</span><span class="p">:</span><span class="s1">&#39;Circuit_Involved_min&#39;</span><span class="p">,</span>
          <span class="s1">&#39;scaled_OTDF_Contribution&#39;</span><span class="p">:</span><span class="s1">&#39;Scaled_OTDF_Contribution_min&#39;</span><span class="p">,</span>
          <span class="s1">&#39;Percent Reduction&#39;</span><span class="p">:</span> <span class="s1">&#39;Percent Reduction_min&#39;</span>
      <span class="p">})</span>
<span class="p">)</span>

<span class="c1"># ─── stitch together the final table ────────────────────────────────────────────</span>
<span class="n">df_agg_final</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">statss</span>
      <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">circ_max</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Bus_ID&#39;</span><span class="p">,</span><span class="s1">&#39;Bus_Name&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">circ_min</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Bus_ID&#39;</span><span class="p">,</span><span class="s1">&#39;Bus_Name&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># ─── write out or return ───────────────────────────────────────────────────────</span>
<span class="n">df_agg_final</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Results/global_agg_final_S</span><span class="si">{</span><span class="n">maximize_solar</span><span class="si">}</span><span class="s2">_W</span><span class="si">{</span><span class="n">maximize_wind</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Success] Final OTDF aggregator saved&quot;</span><span class="p">)</span>

<span class="c1"># Top 5 buses by maximum scaled OTDF contribution</span>
<span class="n">top5</span> <span class="o">=</span> <span class="n">df_agg_final</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;Max_sOTDF&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Top 5 buses by Max_sOTDF ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">top5</span><span class="p">[[</span><span class="s1">&#39;Bus_ID&#39;</span><span class="p">,</span><span class="s1">&#39;Bus_Name&#39;</span><span class="p">,</span><span class="s1">&#39;Max_sOTDF&#39;</span><span class="p">,</span><span class="s1">&#39;Circuit_Involved_max&#39;</span><span class="p">]])</span>

<span class="c1"># Bottom 5 buses by maximum scaled OTDF contribution</span>
<span class="n">bot5</span> <span class="o">=</span> <span class="n">df_agg_final</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;Max_sOTDF&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Bottom 5 buses by Max_sOTDF ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bot5</span><span class="p">[[</span><span class="s1">&#39;Bus_ID&#39;</span><span class="p">,</span><span class="s1">&#39;Bus_Name&#39;</span><span class="p">,</span><span class="s1">&#39;Max_sOTDF&#39;</span><span class="p">,</span><span class="s1">&#39;Circuit_Involved_max&#39;</span><span class="p">]])</span>

<span class="c1"># Top 5 buses by maximum scaled OTDF contribution</span>
<span class="n">top5</span> <span class="o">=</span> <span class="n">df_agg_final</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;Cum_sOTDF&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Top 5 buses by Cum_sOTDF ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">top5</span><span class="p">[[</span><span class="s1">&#39;Bus_ID&#39;</span><span class="p">,</span><span class="s1">&#39;Bus_Name&#39;</span><span class="p">,</span><span class="s1">&#39;Cum_sOTDF&#39;</span><span class="p">,</span><span class="s1">&#39;Circuit_Involved_max&#39;</span><span class="p">]])</span>

<span class="c1"># Bottom 5 buses by maximum scaled OTDF contribution</span>
<span class="n">bot5</span> <span class="o">=</span> <span class="n">df_agg_final</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;Cum_sOTDF&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Bottom 5 buses by Cum_sOTDF ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bot5</span><span class="p">[[</span><span class="s1">&#39;Bus_ID&#39;</span><span class="p">,</span><span class="s1">&#39;Bus_Name&#39;</span><span class="p">,</span><span class="s1">&#39;Cum_sOTDF&#39;</span><span class="p">,</span><span class="s1">&#39;Circuit_Involved_max&#39;</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>net_cont exists? True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">import</span> <span class="nn">plotly.io</span> <span class="k">as</span> <span class="nn">pio</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">display</span>

<span class="k">def</span> <span class="nf">plot_network</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">bus_ids</span><span class="p">,</span> <span class="n">cont_relevant_results</span><span class="p">):</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

    <span class="c1"># Prepare a color map for power flows</span>
    <span class="k">def</span> <span class="nf">get_line_color</span><span class="p">(</span><span class="n">loading_percent</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">loading_percent</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    
    <span class="c1"># Prepare a color map for node LODF</span>
    <span class="k">def</span> <span class="nf">get_node_color</span><span class="p">(</span><span class="n">lodf_pct</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">lodf_pct</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Handle coordinates for buses, bus_names, and annotations</span>
    <span class="n">adjusted_coords</span> <span class="o">=</span> <span class="p">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]:</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;y1&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;bus_names&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;y1&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;y1&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)}</span>

    <span class="c1"># Cache annotations for adding them in one go later</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">traces</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Handle bus plotting</span>
    <span class="k">for</span> <span class="n">bus_id</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bus_name</span><span class="p">)</span> <span class="ow">in</span> <span class="n">adjusted_coords</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">df_agg_final</span><span class="p">[</span><span class="n">df_agg_final</span><span class="p">[</span><span class="s2">&quot;Bus_Name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">bus_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stats</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">cum</span>       <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Cum_sOTDF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">max_s</span>     <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Max_sOTDF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">circ_max</span>  <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Circuit_Involved_max&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">min_s</span>     <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Min_sOTDF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">circ_min</span>  <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;Circuit_Involved_min&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cum</span> <span class="o">=</span> <span class="n">max_s</span> <span class="o">=</span> <span class="n">circ_max</span> <span class="o">=</span> <span class="n">min_s</span> <span class="o">=</span> <span class="n">circ_min</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cum</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">)):</span>
            <span class="n">nc</span> <span class="o">=</span> <span class="n">get_node_color</span><span class="p">(</span><span class="n">cum</span><span class="p">)</span>
            <span class="n">node_color</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;rgba(</span><span class="si">{</span><span class="mi">255</span><span class="o">*</span><span class="n">nc</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">, 0, </span><span class="si">{</span><span class="mi">255</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nc</span><span class="p">)</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">, 1)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node_color</span> <span class="o">=</span> <span class="s1">&#39;rgba(128,128,128,1)&#39;</span>
        <span class="c1"># Build hover‐text</span>
        <span class="n">hover_text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;b&gt;Bus </span><span class="si">{</span><span class="n">bus_name</span><span class="si">}</span><span class="s2"> (ID </span><span class="si">{</span><span class="n">bus_id</span><span class="si">}</span><span class="s2">)&lt;/b&gt;&lt;br&gt;&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Cum_sOTDF: </span><span class="si">{</span><span class="n">cum</span><span class="si">}</span><span class="s2">&lt;br&gt;&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Max_sOTDF: </span><span class="si">{</span><span class="n">max_s</span><span class="si">}</span><span class="s2"> (Circuit: </span><span class="si">{</span><span class="n">circ_max</span><span class="si">}</span><span class="s2">)&lt;br&gt;&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Min_sOTDF: </span><span class="si">{</span><span class="n">min_s</span><span class="si">}</span><span class="s2"> (Circuit: </span><span class="si">{</span><span class="n">circ_min</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Add it as a marker trace</span>
        <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">y</span><span class="p">],</span>
            <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="n">hover_text</span><span class="p">],</span>
            <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Bus </span><span class="si">{</span><span class="n">bus_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">))</span>

        <span class="c1"># Always annotate the bus name</span>
        <span class="n">annotations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">bus_name</span><span class="p">,</span>
            <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#ffffff&quot;</span><span class="p">),</span>
            <span class="n">bgcolor</span><span class="o">=</span><span class="n">node_color</span><span class="p">,</span><span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span>
        <span class="p">))</span>

    <span class="c1">#Filter out zero or NaN loading</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;loading_percent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;loading_percent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="p">]</span>
    <span class="c1"># Handle lines plotting</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">loading_percent</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;loading_percent&#39;</span><span class="p">]</span>
        
        <span class="c1"># Skip plotting lines if the loading_percent is 0</span>
        <span class="k">if</span> <span class="n">loading_percent</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">loading_percent</span><span class="p">):</span>
            <span class="k">continue</span>
            
        <span class="n">from_coords</span> <span class="o">=</span> <span class="n">adjusted_coords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;from_bus&#39;</span><span class="p">],</span><span class="s1">&#39;old_index&#39;</span><span class="p">])</span>
        <span class="n">to_coords</span> <span class="o">=</span> <span class="n">adjusted_coords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;to_bus&#39;</span><span class="p">],</span><span class="s1">&#39;old_index&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">from_coords</span> <span class="ow">and</span> <span class="n">to_coords</span><span class="p">:</span>
            <span class="n">loading_percent</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;loading_percent&#39;</span><span class="p">]</span>
            <span class="n">line_color</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;rgba(</span><span class="si">{</span><span class="mi">255</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">get_line_color</span><span class="p">(</span><span class="n">loading_percent</span><span class="p">)</span><span class="si">}</span><span class="s1">, 0, </span><span class="si">{</span><span class="mi">255</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">get_line_color</span><span class="p">(</span><span class="n">loading_percent</span><span class="p">))</span><span class="si">}</span><span class="s1">, 1)&#39;</span>
            <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">from_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">to_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">from_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">to_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                                     <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
                                     <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>

            <span class="n">mid_x</span><span class="p">,</span> <span class="n">mid_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">from_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">to_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">from_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">to_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="c1"># Check if there&#39;s relevant contingency data</span>
            <span class="n">contingency_info</span> <span class="o">=</span> <span class="n">cont_relevant_results</span><span class="p">[</span><span class="n">cont_relevant_results</span><span class="p">[</span><span class="s1">&#39;Element Name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">contingency_info</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">contingency_relevant_pct</span> <span class="o">=</span> <span class="n">contingency_info</span><span class="p">[</span><span class="s1">&#39;Max Loading %&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">cause_element_name</span> <span class="o">=</span> <span class="n">contingency_info</span><span class="p">[</span><span class="s1">&#39;Cause Element Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">contingency_relevant_pct</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>
                <span class="n">cause_element_name</span> <span class="o">=</span> <span class="s2">&quot;No data&quot;</span>

            <span class="c1"># Add text to display on hover only</span>
            <span class="n">text_line</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Line </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;br&gt;</span><span class="si">{</span><span class="n">loading_percent</span><span class="si">}</span><span class="s2">% loading&lt;br&gt;&quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">contingency_relevant_pct</span><span class="si">}</span><span class="s2">% under worst N-1 scenario&lt;br&gt;&quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;Caused by: </span><span class="si">{</span><span class="n">cause_element_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">mid_x</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">mid_y</span><span class="p">],</span> <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="n">text_line</span><span class="p">],</span> <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
                                     <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">)))</span>

            <span class="c1"># Add arrow annotation for power flow direction if needed</span>
            <span class="n">arrow_x</span><span class="p">,</span> <span class="n">arrow_y</span><span class="p">,</span> <span class="n">ax_x</span><span class="p">,</span> <span class="n">ax_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">to_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">from_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">from_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;p_from_mw&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="n">from_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">from_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">to_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">to_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">annotations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">mid_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">mid_y</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_x</span><span class="p">,</span> <span class="n">ay</span><span class="o">=</span><span class="n">ax_y</span><span class="p">,</span> <span class="n">xref</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">yref</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">axref</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">ayref</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">showarrow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">arrowhead</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">arrowsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">arrowwidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">arrowcolor</span><span class="o">=</span><span class="n">line_color</span><span class="p">))</span>

    <span class="c1"># Add traces and annotations to the figure</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_traces</span><span class="p">(</span><span class="n">traces</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">annotations</span><span class="o">=</span><span class="n">annotations</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Network Diagram with Power Flow Results&quot;</span><span class="p">,</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">50</span><span class="p">),</span>
        <span class="c1">#width=1000,</span>
        <span class="c1">#height=800,</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">autorange</span><span class="o">=</span><span class="s2">&quot;reversed&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1">#fig.show()</span>
    <span class="k">return</span> <span class="n">fig</span>
    
<span class="c1">#Put from and to bus into line results</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">res_line</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;line_id&#39;</span><span class="p">})</span>

<span class="c1">#grab exactly the in‐service metadata from net.line</span>
<span class="n">meta</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">],</span>        <span class="c1"># only in‐service rows</span>
    <span class="p">[</span><span class="s1">&#39;from_bus&#39;</span><span class="p">,</span><span class="s1">&#39;to_bus&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>   <span class="c1"># as a list, not separate args</span>
<span class="p">]</span>

<span class="c1"># merge on the shared key line_id ↔ net.line.index</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">meta</span><span class="p">,</span>
    <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;line_id&#39;</span><span class="p">,</span>
    <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
<span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plot_network</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">bus_ids</span><span class="p">,</span> <span class="n">contingency_output</span><span class="p">)</span>
<span class="c1">#Let Plotly&#39;s layout be autosized</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1">#Convert the figure to HTML with responsive config</span>
<span class="n">html_str</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span>
    <span class="n">full_html</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">include_plotlyjs</span><span class="o">=</span><span class="s2">&quot;cdn&quot;</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;responsive&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>  <span class="c1"># Make the figure responsive</span>
<span class="p">)</span>

<span class="c1"># Embed it in the notebook.</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">display</span>
<span class="c1">#Wrap it in a div that spans 100% width</span>
<span class="n">html_code</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;div style=&quot;max-width: 100%; margin: 0 auto;&quot;&gt;</span>
<span class="si">{</span><span class="n">html_str</span><span class="si">}</span>
<span class="s2">&lt;/div&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">html_code</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">126</span>
<span class="g g-Whitespace">    </span><span class="mi">123</span>     <span class="k">return</span> <span class="n">fig</span>
<span class="g g-Whitespace">    </span><span class="mi">125</span> <span class="c1">#Put from and to bus into line results</span>
<span class="ne">--&gt; </span><span class="mi">126</span> <span class="n">df</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">res_line</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;line_id&#39;</span><span class="p">})</span>
<span class="g g-Whitespace">    </span><span class="mi">128</span> <span class="c1">#grab exactly the in‐service metadata from net.line</span>
<span class="g g-Whitespace">    </span><span class="mi">129</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
<span class="g g-Whitespace">    </span><span class="mi">130</span>     <span class="n">net</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;in_service&#39;</span><span class="p">],</span>        <span class="c1"># only in‐service rows</span>
<span class="g g-Whitespace">    </span><span class="mi">131</span>     <span class="p">[</span><span class="s1">&#39;from_bus&#39;</span><span class="p">,</span><span class="s1">&#39;to_bus&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>   <span class="c1"># as a list, not separate args</span>
<span class="g g-Whitespace">    </span><span class="mi">132</span> <span class="p">]</span>

<span class="ne">NameError</span>: name &#39;net&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>The user also has the ability to list any network element in order to monitor changes to the power flow result caused by the varied dispatches comparing different sensitiities. Sensitivities can be adjusted by the user to compare generator locations, network reinforcements and many more. The plot below demonstrates loading percentages on the monitored element for each of the unique cases where each sensitivity scenario captures an example PV project at differerent nodes. Line loading percentages under the worst case contingency are plotted, but other system result metrics such as bus voltage can be chosen as well:</p>
<p><img alt="Loading Percentages for Monitored Element Across Sensitivities" src="_images/Louth_Lisdrum_Contingency_Plot.png" /></p>
<p><strong>Detailed intact powerflow, contingency and BESS nodal results</strong></p>
<ul class="simple">
<li><p>The user can specify which sensitivities they would like to have run in order to compare the results with/without certain elements, network upgrades, or generator sizes. Allowing the user to gage the net impact of select changes and easily compare future options. The amount of unique cases can be reduced or increased as necessary. Users can then review comprehensive bus, line, and transformer intact and contingency results.</p></li>
<li><p>Various power flow calculation methods are attempted each time, although typically success is reached by utilizing Newton Raphson initialized in a DC manner with Q limits on each generator enforced.</p></li>
<li><p>The results allow the user to compare the worst case contingency to the latest ECP constraint reports. This enables the user to make development decisions that are backed by the most recent load flows in the time periods between new ECP constraint reports. It also has a faster turnaround time compared to other reports and studies completed within the industry.</p></li>
</ul>
<p><img alt="Plotly output from powerflow" src="_images/Plotly_output.png" /></p>
<ul class="simple">
<li><p>For each successful case, the user has the option to create a network diagram to display the power flow results. Plotly is used to display these results from PandaPower. This sample shows output from a wind dominant dispatch with BESS units set to zero in the summer season with peak demand in 2031.</p></li>
<li><p>By hovering over the midpoint of each line, the user can determine the line name, intact loading percentage, real and reactive power, worst case loading percentage and the element which causes that worst case overload. Each line is color coded based on intact line loading, turning more red-tinted as the loading increases and blue as the line loading decreases. In the above example, Cahir-Doon experiences a line loading of roughly 100%. Arrows on each line display the real power flow direction. By hovering over each node, results from the test BESS net impact are found, allowing the user to quickly compare which nodes would have a better net loading impact by having a charging or discharging generator connected at the node.</p></li>
<li><p>For any specific case, or groups of cases, shift factor analysis can be performed on each worst case contingency. Not only does this provide a comprehensive view of the system as to where additional generation or demand can be placed to have minimal impact on loading, but it also provides a view as to which nodes are likely to be prioritized when curtailment allocation needs to take place to alleviate transmission constraint. This clarity on which constraints become “governing” is important as the TSO shifts its perspective as to which network upgrades will be prioritized and renewable generation connecting ahead of select upgrades.</p></li>
</ul>
<p><strong>Further options and additional functionality</strong></p>
<p>Additional functionality includes but is not limited to:</p>
<ul class="simple">
<li><p>Nodal hosting capacity analysis</p></li>
<li><p>Generator connection method option comparison</p></li>
<li><p>Network reinforcement sensitivities</p></li>
<li><p>Contingency Analysis</p></li>
</ul>
<p>Further options under development:</p>
<ul class="simple">
<li><p>Integration with ChatGPT or Llama for comprehensive queries</p></li>
</ul>
<p>Advantages and Disadvantages:</p>
<ul class="simple">
<li><p>Significantly cheaper than TARA or PSSE.</p></li>
<li><p>More easily adaptable to various python libraries and packages.</p></li>
<li><p>Minimal technical or power system knowledge required.</p></li>
</ul>
<p>While this tool is not perfect, it provides a quick, light-weight screening for HV transmission nodes in the Irish system. The background data feeding into this tool is reviewed, aggregated, and compared against the latest system information provided publicly by Eirgrid and ESB.</p>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="intro.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Welcome to a new power system screening tool for the Republic of Ireland</p>
      </div>
    </a>
    <a class="right-next"
       href="Case%20Study.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Case Study</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>